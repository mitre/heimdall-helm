apiVersion: apps/v1
kind: StatefulSet
metadata:
  name:  {{ include "heimdall.fullname" . }}
  labels:
    {{- include "heimdall.labels" . | nindent 4 }}
    app.kubernetes.io/component: heimdall
spec:
  serviceName: {{ template "heimdall.fullname" . }}
  replicas: 1
  selector:
    matchLabels:
      {{- include "heimdall.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: heimdall
  template:
    metadata:
      {{- with .Values.heimdall.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "heimdall.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: heimdall
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.heimdall.podSecurityContext | nindent 8 }}
      volumes:
        - name: yarn-cache
          emptyDir: {}
        - name: yarn-tmp
          emptyDir: {}
        {{ if .Values.certs.enabled -}}        
        - name: injected-certs
          configMap:
            name: {{ .Values.certs.name }}
        {{- if .Values.certs.systemCertsApproach.enabled}}    
        {{- range $index, $path := .Values.certs.systemCertsApproach.processedCertsMountPaths }}
        - name: "processed-certs-{{ $index }}"
          emptyDir:
        {{- end }}
        {{- end }}
        {{- end }}
      {{- if and .Values.certs.systemCertsApproach.enabled .Values.certs.enabled }}
      initContainers:
        - name: setup-certs
          securityContext:
            {{- toYaml .Values.certs.systemCertsApproach.securityContext | nindent 12 }}
          image: "{{ .Values.certs.systemCertsApproach.image.repository }}:{{ .Values.certs.systemCertsApproach.image.tag }}"
          resources:
            {{- toYaml .Values.certs.systemCertsApproach.resources | nindent 12 }}
          imagePullPolicy: {{ .Values.certs.systemCertsApproach.image.pullPolicy }}
          command: {{ .Values.certs.systemCertsApproach.command }}
          volumeMounts:
            - name: injected-certs
              mountPath: {{ .Values.certs.systemCertsApproach.injectedCertsMountPath }}
            {{- range $index, $path := .Values.certs.systemCertsApproach.processedCertsMountPaths }}
            - name: "processed-certs-{{ $index }}"
              mountPath: {{ $path }}
            {{- end }}
      {{- end }}
      containers:
        - name: heimdall-front
          securityContext:
            {{- toYaml .Values.heimdall.securityContext | nindent 12 }}
          resources:
            {{- toYaml .Values.heimdall.resources | nindent 12 }}
          image: "{{ .Values.heimdall.image.repository }}:{{ .Values.heimdall.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.heimdall.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 3000
          volumeMounts:
            - name: yarn-cache
              mountPath: /home/node/.cache
            - name: yarn-tmp
              mountPath: /tmp
            {{- if .Values.certs.enabled }}
            {{- if .Values.certs.systemCertsApproach.enabled }}
            {{- range $index, $path := .Values.certs.systemCertsApproach.processedCertsMountPaths }}
            - name: "processed-certs-{{ $index }}"
              mountPath: {{ $path }}
              readOnly: true
            {{- end }}    
            {{- else }}
            - name: "injected-certs"
              mountPath: /home/node/certs
            {{- end }}
            {{- end }}
          # ===================================================================
          # Environment Variables - Load from ConfigMap and Secret
          # ===================================================================
          # Following Vulcan pattern: use envFrom for bulk loading, env for overrides
          envFrom:
          - configMapRef:
              name: {{ include "heimdall.fullname" . }}-config
          - secretRef:
              name: {{ ternary .Values.heimdall.existingSecret (printf "%s-secrets" (include "heimdall.fullname" .)) (not (empty .Values.heimdall.existingSecret)) }}
          env:
          {{- if and (not .Values.certs.systemCertsApproach.enabled) .Values.certs.enabled }}
          - name: NODE_EXTRA_CA_CERTS
            value: /home/node/certs/certs.pem
          - name: SSL_CERT_FILE
            value: /home/node/certs/certs.pem
          {{- end }}
          # DATABASE_PASSWORD injection based on deployment pattern
          # Pattern 1: Embedded PostgreSQL - reference Bitnami's secret
          {{- if .Values.postgresql.enabled }}
          - name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "heimdall.databaseSecretName" . }}
                key: {{ include "heimdall.databaseSecretKey" . }}
          {{- else if .Values.externalDatabase.existingSecret }}
          # Pattern 2: External DB with existing secret
          - name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ .Values.externalDatabase.existingSecret }}
                key: {{ .Values.externalDatabase.existingSecretPasswordKey | default "password" }}
          {{- end }}
          # Pattern 3: External DB without existing secret - comes from envFrom heimdall-secrets above
          livenessProbe:
            {{- with .Values.heimdall.livenessProbe }}
            httpGet:
              path: {{ .httpGet.path }}
              port: {{ .httpGet.port }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            periodSeconds: {{ .periodSeconds }}
            timeoutSeconds: {{ .timeoutSeconds }}
            failureThreshold: {{ .failureThreshold }}
            {{- end }}

          readinessProbe:
            {{- with .Values.heimdall.readinessProbe }}
            httpGet:
              path: {{ .httpGet.path }}
              port: {{ .httpGet.port }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            periodSeconds: {{ .periodSeconds }}
            timeoutSeconds: {{ .timeoutSeconds }}
            failureThreshold: {{ .failureThreshold }}
            {{- end }}
      {{- with .Values.heimdall.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.heimdall.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.heimdall.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: Always
