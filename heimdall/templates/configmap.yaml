apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "heimdall.fullname" . }}-config
  labels:
    {{- include "heimdall.labels" . | nindent 4 }}
data:
  # =============================================================================
  # Templated Configuration (Template helpers and values.yaml)
  # =============================================================================
  # These values are managed by template logic and take precedence over file

  # Database Connection (from helpers - handles embedded vs external)
  DATABASE_HOST: {{ include "heimdall.databaseHost" . | quote }}
  DATABASE_PORT: {{ include "heimdall.databasePort" . | quote }}
  DATABASE_NAME: {{ include "heimdall.databaseName" . | quote }}
  DATABASE_USERNAME: {{ include "heimdall.databaseUsername" . | quote }}

  # Node Environment (from values.yaml)
  NODE_ENV: {{ .Values.nodeEnv | quote }}

  # External URL (auto-constructed from ingress or explicit config)
  {{- if and .Values.heimdall.ingress.enabled (index .Values.heimdall.ingress.hosts 0) }}
  {{- $host := (index .Values.heimdall.ingress.hosts 0).host }}
  {{- $scheme := "https" }}
  {{- if not (and .Values.heimdall.config (hasKey .Values.heimdall.config "EXTERNAL_URL")) }}
  EXTERNAL_URL: {{ printf "%s://%s" $scheme $host | quote }}
  {{- end }}
  {{- else if and .Values.heimdall.config (hasKey .Values.heimdall.config "EXTERNAL_URL") }}
  {{- $externalUrl := .Values.heimdall.config.EXTERNAL_URL }}
  {{- if or (hasSuffix "/authn" $externalUrl) (contains "/authn/" $externalUrl) }}
  {{- fail "ERROR: heimdall.config.EXTERNAL_URL must NOT include '/authn' path. Use base URL only (e.g., 'https://heimdall.example.com'). Heimdall automatically appends '/authn' for OAuth callbacks." }}
  {{- end }}
  EXTERNAL_URL: {{ $externalUrl | quote }}
  {{- else }}
  EXTERNAL_URL: ""
  {{- end }}

  # =============================================================================
  # OAuth/OIDC Configuration Validation
  # =============================================================================
  # Validate paired Client ID + Secret configurations
  {{- if .Values.heimdall.config }}
  {{- if and (hasKey .Values.heimdall.config "GITHUB_CLIENT_ID") (not (hasKey .Values.heimdall.secrets "GITHUB_CLIENT_SECRET")) }}
  {{- fail "ERROR: GITHUB_CLIENT_ID is set but GITHUB_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret." }}
  {{- end }}
  {{- if and (hasKey .Values.heimdall.config "GITLAB_CLIENT_ID") (not (hasKey .Values.heimdall.secrets "GITLAB_CLIENT_SECRET")) }}
  {{- fail "ERROR: GITLAB_CLIENT_ID is set but GITLAB_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret." }}
  {{- end }}
  {{- if and (hasKey .Values.heimdall.config "GOOGLE_CLIENT_ID") (not (hasKey .Values.heimdall.secrets "GOOGLE_CLIENT_SECRET")) }}
  {{- fail "ERROR: GOOGLE_CLIENT_ID is set but GOOGLE_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret." }}
  {{- end }}
  {{- if and (hasKey .Values.heimdall.config "OIDC_CLIENT_ID") (not (hasKey .Values.heimdall.secrets "OIDC_CLIENT_SECRET")) }}
  {{- fail "ERROR: OIDC_CLIENT_ID is set but OIDC_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret." }}
  {{- end }}
  {{- if and (hasKey .Values.heimdall.config "OKTA_CLIENT_ID") (not (hasKey .Values.heimdall.secrets "OKTA_CLIENT_SECRET")) }}
  {{- fail "ERROR: OKTA_CLIENT_ID is set but OKTA_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret." }}
  {{- end }}

  # Validate OIDC URL consistency (all URLs should use same domain)
  {{- if hasKey .Values.heimdall.config "OIDC_ISSUER" }}
  {{- $oidcIssuer := .Values.heimdall.config.OIDC_ISSUER }}
  {{- if not (and (hasKey .Values.heimdall.config "OIDC_AUTHORIZATION_URL") (hasKey .Values.heimdall.config "OIDC_TOKEN_URL") (hasKey .Values.heimdall.config "OIDC_USER_INFO_URL")) }}
  {{- fail "ERROR: When OIDC_ISSUER is set, you must also set OIDC_AUTHORIZATION_URL, OIDC_TOKEN_URL, and OIDC_USER_INFO_URL." }}
  {{- end }}
  {{- end }}

  # Validate GitLab BASE_URL doesn't have trailing slash
  {{- if hasKey .Values.heimdall.config "GITLAB_BASE_URL" }}
  {{- $gitlabUrl := .Values.heimdall.config.GITLAB_BASE_URL }}
  {{- if hasSuffix "/" $gitlabUrl }}
  {{- fail "ERROR: GITLAB_BASE_URL must NOT have a trailing slash. Use 'https://gitlab.example.com' not 'https://gitlab.example.com/'." }}
  {{- end }}
  {{- end }}
  {{- end }}

  # =============================================================================
  # Load Additional Non-Sensitive Environment Variables from File
  # =============================================================================
  # env/heimdallconfig.yaml contains default non-sensitive configuration
  # NOTE: NODE_ENV, DATABASE_*, and EXTERNAL_URL are NOT in file (managed above)
{{ range .Files.Lines "env/heimdallconfig.yaml" }}
  {{ . }}
{{ end }}

  # =============================================================================
  # Override with Inline Config from values.yaml (if provided)
  # =============================================================================
  # Allows overriding file-based config via values.yaml or --set flags
  # NOTE: EXTERNAL_URL is managed above (skip it here to avoid duplicates)
  {{- if .Values.heimdall.config }}
  {{- range $key, $val := .Values.heimdall.config }}
  {{- if ne $key "EXTERNAL_URL" }}
  {{ $key }}: {{ $val | quote }}
  {{- end }}
  {{- end }}
  {{- end }}
