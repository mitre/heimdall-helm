suite: test heimdall statefulset critical logic
templates:
  - heimdall-statefulset.yaml
tests:
  #
  # Test 1: Basic StatefulSet Structure
  #
  - it: should create a StatefulSet
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall

  #
  # Test 2: Replicas
  #
  - it: should set replicas to 1 by default
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  #
  # Test 3: envFrom Pattern (ConfigMap + Secrets)
  #
  - it: should use envFrom for ConfigMap
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].envFrom
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].configMapRef.name
          value: RELEASE-NAME-heimdall-config

  - it: should use envFrom for Secrets with correct name
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].envFrom
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].secretRef.name
          value: RELEASE-NAME-heimdall-secrets

  #
  # Test 4: Secrets Priority (existingSecret takes precedence)
  #
  - it: should use existingSecret when specified
    set:
      heimdall.existingSecret: my-existing-secret
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[1].secretRef.name
          value: my-existing-secret

  #
  # Test 5: Container Name and Image
  #
  - it: should have heimdall-front container
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: heimdall-front

  - it: should use default image heimdall-app:arm64-test
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "heimdall-app:arm64-test"

  #
  # Test 6: Health Probes
  #
  - it: should have startupProbe configured
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].startupProbe
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: 3000

  - it: should have livenessProbe configured
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /

  #
  # Test 7: Environment Variable Injection
  #
  - it: should inject DATABASE_PASSWORD from embedded PostgreSQL secret
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-heimdall-postgresql
                key: postgres-password
