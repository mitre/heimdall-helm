suite: test heimdall secrets management
templates:
  - heimdall-secrets.yaml
tests:
  #
  # Test 1: Existing Secret (Approach 1 - Highest Priority)
  #
  - it: should NOT create Secret when existingSecret is specified
    set:
      heimdall.existingSecret: my-existing-secret
    asserts:
      - hasDocuments:
          count: 0

  #
  # Test 2: Inline Secrets (Approach 3 - Medium Priority)
  #
  - it: should create Secret with inline secrets from values
    set:
      heimdall.secrets.jwtSecret: "inline_jwt_secret_value"
      heimdall.secrets.adminPassword: "inline_admin_password"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall-secrets
      - equal:
          path: type
          value: Opaque
      - equal:
          path: stringData.jwtSecret
          value: "inline_jwt_secret_value"
      - equal:
          path: stringData.adminPassword
          value: "inline_admin_password"

  - it: should handle multiple inline secrets
    set:
      heimdall.secrets.jwtSecret: "jwt_value"
      heimdall.secrets.adminPassword: "admin_value"
      heimdall.secrets.databasePassword: "db_value"
      heimdall.secrets.githubClientSecret: "github_value"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.jwtSecret
          value: "jwt_value"
      - equal:
          path: stringData.adminPassword
          value: "admin_value"
      - equal:
          path: stringData.databasePassword
          value: "db_value"
      - equal:
          path: stringData.githubClientSecret
          value: "github_value"

  #
  # Test 3: File-based Secrets (Approach 2 - Lower Priority)
  #
  # Note: helm-unittest cannot test file loading (.Files.Get)
  # This test verifies the template creates a Secret when secretsFiles is set,
  # but actual file content validation must be done in integration tests
  - it: should create Secret when secretsFiles is configured
    set:
      heimdall.secretsFiles:
        - env/heimdall-secrets.yaml
      # Provide at least one inline secret to make stringData non-empty
      heimdall.secrets.jwtSecret: "file_based_test"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: stringData

  #
  # Test 4: Default Behavior (Inline Secrets Required)
  #
  # Note: Default secretsFiles cannot be tested in helm-unittest
  # since .Files.Get only works with real file system
  - it: should create Secret with at least one secret value
    set:
      heimdall.secrets.jwtSecret: "default_test"
    asserts:
      - isKind:
          of: Secret
      - isNotEmpty:
          path: stringData

  #
  # Test 5: Priority Order (Inline > File)
  #
  - it: should prefer inline secrets over file-based secrets
    set:
      heimdall.secrets.jwtSecret: "inline_jwt_priority_test"
      heimdall.secretsFiles:
        - env/heimdall-secrets.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.jwtSecret
          value: "inline_jwt_priority_test"

  #
  # Test 6: Secret Metadata
  #
  - it: should have correct labels
    set:
      heimdall.secrets.jwtSecret: "test"
    asserts:
      - equal:
          path: metadata.labels
          value:
            helm.sh/chart: heimdall-1.0.0
            app.kubernetes.io/name: heimdall
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/version: "release-latest"
            app.kubernetes.io/managed-by: Helm

  #
  # Test 7: Secret Type
  #
  - it: should use Opaque secret type
    set:
      heimdall.secrets.jwtSecret: "test"
    asserts:
      - equal:
          path: type
          value: Opaque
