suite: test heimdall configmap environment variables
templates:
  - configmap.yaml
tests:
  #
  # Test 1: ConfigMap Creation
  #
  - it: should create a ConfigMap
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-heimdall-config

  #
  # Test 2: Database Configuration (Embedded PostgreSQL)
  #
  - it: should set DATABASE_HOST to embedded PostgreSQL service by default
    asserts:
      - equal:
          path: data.DATABASE_HOST
          value: RELEASE-NAME-heimdall-postgresql

  - it: should set DATABASE_PORT to 5432 by default
    asserts:
      - equal:
          path: data.DATABASE_PORT
          value: "5432"

  - it: should set DATABASE_NAME from values
    asserts:
      - equal:
          path: data.DATABASE_NAME
          value: heimdall

  - it: should set DATABASE_USERNAME from values
    asserts:
      - equal:
          path: data.DATABASE_USERNAME
          value: postgres

  #
  # Test 3: External Database Configuration
  #
  - it: should use external database host when postgresql.enabled=false
    set:
      postgresql.enabled: false
      externalDatabase.host: external-db.example.com
      externalDatabase.port: 5432
      externalDatabase.database: heimdall_prod
      externalDatabase.username: heimdall_user
    asserts:
      - equal:
          path: data.DATABASE_HOST
          value: external-db.example.com
      - equal:
          path: data.DATABASE_NAME
          value: heimdall_prod
      - equal:
          path: data.DATABASE_USERNAME
          value: heimdall_user

  #
  # Test 4: Node Environment
  #
  - it: should set NODE_ENV to production by default
    asserts:
      - equal:
          path: data.NODE_ENV
          value: production

  - it: should allow custom NODE_ENV via nodeEnv value
    set:
      nodeEnv: development
    asserts:
      - equal:
          path: data.NODE_ENV
          value: development

  #
  # Test 5: External URL (Required for OAuth callbacks)
  #
  - it: should set EXTERNAL_URL when provided via heimdall.config
    set:
      heimdall.config.EXTERNAL_URL: https://heimdall.example.com
    asserts:
      - equal:
          path: data.EXTERNAL_URL
          value: https://heimdall.example.com

  #
  # Test 6: Additional Config Variables
  #
  - it: should set custom config variables via heimdall.config
    set:
      heimdall.config.CUSTOM_VAR: "custom_value"
    asserts:
      - equal:
          path: data.CUSTOM_VAR
          value: custom_value

  #
  # Test 7: OAuth/OIDC Validation - EXTERNAL_URL
  #
  # Note: EXTERNAL_URL with /authn path is caught by JSON Schema pattern validation
  # Schema pattern: ^https?://[^/]+$ rejects URLs with paths
  # Template validation provides additional check for edge cases

  #
  # Test 8: OAuth/OIDC Validation - Paired Client ID/Secret
  #
  - it: should fail when GITHUB_CLIENT_ID is set without GITHUB_CLIENT_SECRET
    set:
      heimdall.config.GITHUB_CLIENT_ID: "test123"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: GITHUB_CLIENT_ID is set but GITHUB_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret."

  - it: should fail when GITLAB_CLIENT_ID is set without GITLAB_CLIENT_SECRET
    set:
      heimdall.config.GITLAB_CLIENT_ID: "test123"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: GITLAB_CLIENT_ID is set but GITLAB_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret."

  - it: should fail when GOOGLE_CLIENT_ID is set without GOOGLE_CLIENT_SECRET
    set:
      heimdall.config.GOOGLE_CLIENT_ID: "test123"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: GOOGLE_CLIENT_ID is set but GOOGLE_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret."

  - it: should fail when OIDC_CLIENT_ID is set without OIDC_CLIENT_SECRET
    set:
      heimdall.config.OIDC_CLIENT_ID: "test123"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: OIDC_CLIENT_ID is set but OIDC_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret."

  - it: should fail when OKTA_CLIENT_ID is set without OKTA_CLIENT_SECRET
    set:
      heimdall.config.OKTA_CLIENT_ID: "test123"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: OKTA_CLIENT_ID is set but OKTA_CLIENT_SECRET is missing. OAuth requires both Client ID and Secret."

  #
  # Test 9: OAuth/OIDC Validation - OIDC URL Consistency
  #
  - it: should fail when OIDC_ISSUER is set without required OIDC URLs
    set:
      heimdall.config.OIDC_ISSUER: https://auth.example.com
      heimdall.config.OIDC_CLIENT_ID: test123
      heimdall.secrets.OIDC_CLIENT_SECRET: secret123
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: When OIDC_ISSUER is set, you must also set OIDC_AUTHORIZATION_URL, OIDC_TOKEN_URL, and OIDC_USER_INFO_URL."

  #
  # Test 10: OAuth/OIDC Validation - GitLab BASE_URL
  #
  # Note: GitLab trailing slash is caught by JSON Schema pattern validation
  # Schema pattern: ^https?://[^/]+$ rejects any URL with paths (including trailing slash)
