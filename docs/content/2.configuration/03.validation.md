---
title: Configuration Validation
description: 3-layer validation to prevent common Heimdall misconfigurations
navigation:
  icon: i-lucide-shield-check
---

The Heimdall Helm chart implements **3-layer validation** to prevent common configuration mistakes that cause deployment failures or broken functionality.

## Why Validation Matters

Heimdall configuration is complex with many interconnected settings. Common mistakes include:

- **Authentication**: Setting `EXTERNAL_URL` with `/authn` path → Broken OAuth callback URLs
- **OAuth Providers**: Providing Client ID without Secret → Runtime authentication failures
- **OIDC**: Missing endpoint URLs → Silent authentication failures
- **URLs**: Invalid formats or trailing slashes → Provider rejection
- **LDAP**: Invalid ports or boolean flags → Connection failures

These errors are caught **before deployment** using multiple validation layers.

## Validated Configuration Categories

This chart validates:

- ✅ **All OAuth Providers**: GitHub, GitLab, Google, OIDC, Okta
- ✅ **LDAP Authentication**: Ports, SSL flags, connection settings
- ✅ **URLs**: EXTERNAL_URL, GitLab BASE_URL, OIDC endpoints
- ✅ **Domain Formats**: Okta domains, URI patterns
- ✅ **Paired Values**: Client ID + Secret requirements

## 3-Layer Validation Strategy

### Layer 1: JSON Schema Validation

**When it runs**: Before `helm install` or `helm upgrade`
**What it catches**: Format violations, pattern mismatches, invalid values

Schema validation in `values.schema.json` provides immediate feedback:

```bash
helm install heimdall ./heimdall -f bad-config.yaml
```

```
Error: values don't meet the specifications of the schema(s):
heimdall:
- at '/heimdall/config/EXTERNAL_URL':
  'https://heimdall.example.com/authn' does not match pattern '^https?://[^/]+$'
```

::tip{title="Fast Validation"}
Schema validation fails with clear error messages before any Kubernetes resources are created.
::

### Layer 2: Template Validation

**When it runs**: During `helm template` or `helm install`
**What it catches**: Cross-field dependencies, logical inconsistencies

Template validation using `{{ fail }}` provides contextual validation:

```yaml
{{- if and (hasKey .Values.heimdall.config "GITHUB_CLIENTID")
           (not (hasKey .Values.heimdall.secrets "GITHUB_CLIENTSECRET")) }}
{{- fail "ERROR: GITHUB_CLIENTID is set but GITHUB_CLIENTSECRET is missing." }}
{{- end }}
```

### Layer 3: NOTES.txt Guidance

**When it runs**: After successful `helm install`
**What it shows**: Warnings, configuration guidance, callback URLs

The chart displays helpful guidance when OAuth is configured:

```
⚠ OAuth/OIDC Configuration Detected
════════════════════════════════════════════════════════════════
EXTERNAL_URL is set: https://heimdall.example.com

Important: EXTERNAL_URL must be the base URL only (without /authn path).

When configuring OAuth apps in GitLab/GitHub/Google/Okta, use:
- GitLab:  https://heimdall.example.com/authn/gitlab/callback
- GitHub:  https://heimdall.example.com/authn/github/callback
- OIDC:    https://heimdall.example.com/authn/oidc_callback
```

## Validated Configuration Fields

::accordion

:::accordion-item{icon="i-lucide-link" label="EXTERNAL_URL Validation"}

::caution{title="Common Mistake"}
**NEVER** include `/authn` in `EXTERNAL_URL`. Heimdall automatically appends this path for OAuth callbacks.
::

**Schema Validation**:
- Pattern: `^https?://[^/]+$` (no paths allowed)
- Must be valid URI format

**Template Validation**:
- Explicit check for `/authn` substring
- Fails with clear error message

**Example**:

::code-group
```yaml [✓ Correct]
heimdall:
  config:
    EXTERNAL_URL: "https://heimdall.example.com"
# Results in callback: https://heimdall.example.com/authn/oidc_callback
```

```yaml [✗ Incorrect]
heimdall:
  config:
    EXTERNAL_URL: "https://heimdall.example.com/authn"
# Would result in: https://heimdall.example.com/authn/authn/oidc_callback
```
::

:::

:::accordion-item{icon="i-lucide-key" label="Paired Client ID/Secret"}

All OAuth providers require **both** Client ID and Client Secret.

**Validated Providers**:
- GitHub (`GITHUB_CLIENTID` + `GITHUB_CLIENTSECRET`)
- GitLab (`GITLAB_CLIENTID` + `GITLAB_SECRET`)
- Google (`GOOGLE_CLIENTID` + `GOOGLE_CLIENTSECRET`)
- OIDC (`OIDC_CLIENTID` + `OIDC_CLIENT_SECRET`)
- Okta (`OKTA_CLIENTID` + `OKTA_CLIENTSECRET`)

**Example**:

```yaml
heimdall:
  config:
    GITHUB_CLIENTID: "your-github-client-id"
  secrets:
    GITHUB_CLIENTSECRET: "your-github-client-secret"  # Required!
```

::warning
Client secrets must be in `heimdall.secrets`, not `heimdall.config`.
::

:::

:::accordion-item{icon="i-lucide-shield" label="OIDC URL Consistency"}

When using OIDC, **all 4 endpoint URLs** must be configured together:

**Required URLs**:
- `OIDC_ISSUER` (e.g., `https://auth.example.com`)
- `OIDC_AUTHORIZATION_URL` (e.g., `https://auth.example.com/authorize`)
- `OIDC_TOKEN_URL` (e.g., `https://auth.example.com/token`)
- `OIDC_USER_INFO_URL` (e.g., `https://auth.example.com/userinfo`)

**Template Validation**:
```yaml
{{- if hasKey .Values.heimdall.config "OIDC_ISSUER" }}
{{- if not (and (hasKey "OIDC_AUTHORIZATION_URL")
                (hasKey "OIDC_TOKEN_URL")
                (hasKey "OIDC_USER_INFO_URL")) }}
{{- fail "ERROR: When OIDC_ISSUER is set, all OIDC URLs must be configured." }}
{{- end }}
{{- end }}
```

**Example**:

```yaml
heimdall:
  config:
    OIDC_ISSUER: "https://auth.example.com"
    OIDC_AUTHORIZATION_URL: "https://auth.example.com/oauth2/v1/authorize"
    OIDC_TOKEN_URL: "https://auth.example.com/oauth2/v1/token"
    OIDC_USER_INFO_URL: "https://auth.example.com/oauth2/v1/userinfo"
    OIDC_CLIENTID: "your-client-id"
  secrets:
    OIDC_CLIENT_SECRET: "your-client-secret"
```

:::

:::accordion-item{icon="i-simple-icons-gitlab" label="GitLab BASE_URL"}

GitLab instance URL must **not** have a trailing slash.

**Schema Validation**:
- Pattern: `^https?://[^/]+$` (no trailing slash)

**Template Validation**:
- Explicit `hasSuffix "/"` check

**Example**:

::code-group
```yaml [✓ Correct]
heimdall:
  config:
    GITLAB_BASEURL: "https://gitlab.example.com"
```

```yaml [✗ Incorrect]
heimdall:
  config:
    GITLAB_BASEURL: "https://gitlab.example.com/"
```
::

:::

:::accordion-item{icon="i-simple-icons-okta" label="Okta Domain Format"}

Okta domains must match official Okta patterns.

**Schema Validation**:
- `OKTA_DOMAIN`: Pattern `^[a-z0-9-]+\.(okta|oktapreview|okta-emea)\.com$`
- `OKTA_ISSUER_URL`: Pattern `^https://[a-z0-9-]+\.(okta|oktapreview|okta-emea)\.com`

**Valid Examples**:
- `example.okta.com`
- `dev-12345.oktapreview.com`
- `company.okta-emea.com`

**Invalid Examples**:
- `example.badokta.com` (invalid TLD)
- `okta.com` (missing subdomain)
- `example.okta.org` (wrong TLD)

:::

:::accordion-item{icon="i-lucide-building" label="LDAP Authentication"}

**Port Validation**:
- Pattern: `^[1-9][0-9]{0,4}$` (1-65535)
- Common values: `389` (plain), `636` (SSL)

**Boolean Flags**:
- Enum: `["true", "false"]`
- Examples: `LDAP_ENABLED`, `LDAP_SSL`, `LDAP_SSL_INSECURE`

:::

::

## Testing Validation

The chart includes unit tests for all validations:

```bash
# Run all tests
helm unittest heimdall

# Run only validation tests
helm unittest heimdall -f tests/configmap_test.yaml
```

**Test Coverage**:
- 11 OAuth/OIDC validation tests
- 16 total ConfigMap tests
- 108 total chart tests

## Root Cause: GitHub Issue #7542

The EXTERNAL_URL validation was created after investigating [issue #7542](https://github.com/mitre/heimdall2/issues/7542):

**Reported Bug**: GitLab OAuth callback URL duplicates `externalUrl`:
- Expected: `https://example.com/authn/oidc_callback`
- Actual: `https://example.com/authn/https://example.com/authn/oidc_callback`

**Investigation**: Reviewed Heimdall2 source code (`authn.controller.ts`, passport strategies):

```typescript
// authn.controller.ts
@Controller('authn')  // Adds /authn prefix to all routes
export class AuthnController {
  @Get('oidc_callback')  // Maps to /authn/oidc_callback
}

// oidc.strategy.ts
callbackURL: `${configService.get('EXTERNAL_URL')}/authn/oidc_callback`
```

**Conclusion**: The **code is correct**. The issue was **user configuration error**:
- Users set `EXTERNAL_URL="https://example.com/authn"`
- Code appends `/authn/oidc_callback`
- Result: `https://example.com/authn/authn/oidc_callback`

**Solution**: Multi-layer validation prevents this misconfiguration.

## Best Practices

::tabs

:::tabs-item{label="Development/Testing" icon="i-lucide-flask-conical"}

```yaml
# Use explicit EXTERNAL_URL for local testing
heimdall:
  config:
    EXTERNAL_URL: "http://localhost:8080"

  # Or let chart auto-construct from ingress
  ingress:
    enabled: true
    hosts:
      - host: heimdall.local
        paths:
          - path: /
```

:::

:::tabs-item{label="Production" icon="i-lucide-rocket"}

```yaml
# Use ingress for automatic EXTERNAL_URL
heimdall:
  ingress:
    enabled: true
    className: traefik
    hosts:
      - host: heimdall.example.com
        paths:
          - path: /
    tls:
      - secretName: heimdall-tls
        hosts:
          - heimdall.example.com

# Chart automatically sets:
# EXTERNAL_URL: "https://heimdall.example.com"
```

:::

:::tabs-item{label="External Secrets" icon="i-lucide-vault"}

```yaml
# Use existing secret for all OAuth credentials
heimdall:
  existingSecret: "heimdall-oauth-secrets"

  config:
    GITHUB_CLIENTID: "from-secret"
    GITLAB_CLIENTID: "from-secret"
    OIDC_CLIENTID: "from-secret"

# Secret must contain:
# - GITHUB_CLIENTSECRET
# - GITLAB_SECRET
# - OIDC_CLIENT_SECRET
```

:::

::

## Troubleshooting

::accordion

:::accordion-item{icon="i-lucide-alert-circle" label="Schema Validation Errors"}

**Error**: `'https://example.com/path' does not match pattern '^https?://[^/]+$'`

**Solution**: Remove all paths from URL. Use base domain only:
```yaml
# Change this:
EXTERNAL_URL: "https://example.com/heimdall"

# To this:
EXTERNAL_URL: "https://example.com"
```

:::

:::accordion-item{icon="i-lucide-key-off" label="Missing Client Secret"}

**Error**: `GITHUB_CLIENTID is set but GITHUB_CLIENTSECRET is missing`

**Solution**: Add secret to `heimdall.secrets` or `existingSecret`:
```yaml
heimdall:
  config:
    GITHUB_CLIENTID: "abc123"
  secrets:
    GITHUB_CLIENTSECRET: "xyz789"  # Add this
```

:::

:::accordion-item{icon="i-lucide-settings" label="OIDC Incomplete Configuration"}

**Error**: `When OIDC_ISSUER is set, you must also set OIDC_AUTHORIZATION_URL...`

**Solution**: Configure all 4 OIDC URLs:
```yaml
heimdall:
  config:
    OIDC_ISSUER: "https://auth.example.com"
    OIDC_AUTHORIZATION_URL: "https://auth.example.com/authorize"
    OIDC_TOKEN_URL: "https://auth.example.com/token"
    OIDC_USER_INFO_URL: "https://auth.example.com/userinfo"
```

:::

::

## See Also

- [Environment Variables](/helm-chart/configuration/environment-variables) - Environment variable management
- [Secrets Management](/helm-chart/getting-started/secrets) - Three secrets patterns
- [Testing](/helm-chart/development/testing) - Running validation tests
