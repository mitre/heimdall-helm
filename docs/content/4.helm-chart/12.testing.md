---
title: Testing
description: Comprehensive testing strategy for the Heimdall Helm chart
navigation:
  icon: i-lucide-flask-conical
---

The Heimdall Helm chart includes comprehensive unit tests for all templates and helpers, ensuring reliability and preventing regressions.

## Unit Testing with helm-unittest

The chart uses [helm-unittest](https://github.com/helm-unittest/helm-unittest) for template unit testing without requiring a Kubernetes cluster.

### Quick Start

```bash
# Install helm-unittest plugin
helm plugin install https://github.com/helm-unittest/helm-unittest

# Run all tests
helm unittest ./heimdall

# Run specific test file
helm unittest ./heimdall -f tests/statefulset_test.yaml
```

### Test Results

::callout{icon="i-lucide-check-circle" color="green"}
**92 tests passing** across 11 test suites with **100% template coverage** (~850ms execution time)
::

## Test Suite Coverage

The test suite validates all 10 templates plus template helpers:

::card-group{class="grid-cols-1"}
  ::card{icon="i-lucide-file-code" title="statefulset_test.yaml"}
  **12 tests** - StatefulSet structure, replicas, envFrom pattern, secrets priority, health probes, NODE_EXTRA_CA_CERTS
  ::

  ::card{icon="i-lucide-file-code" title="configmap_test.yaml"}
  **10 tests** - ConfigMap creation, embedded/external database config, NODE_ENV, EXTERNAL_URL
  ::

  ::card{icon="i-lucide-file-code" title="secrets_test.yaml"}
  **8 tests** - Existing secret, inline secrets, file-based secrets, priority order
  ::

  ::card{icon="i-lucide-file-code" title="service_test.yaml"}
  **7 tests** - Service creation, type, port configuration, labels
  ::

  ::card{icon="i-lucide-file-code" title="ingress_test.yaml"}
  **8 tests** - Ingress creation, className, annotations, TLS, multiple hosts
  ::

  ::card{icon="i-lucide-file-code" title="pdb_test.yaml"}
  **8 tests** - PodDisruptionBudget creation, minAvailable, maxUnavailable (integers + percentages)
  ::

  ::card{icon="i-lucide-file-code" title="hpa_test.yaml"}
  **8 tests** - HorizontalPodAutoscaler creation, replicas, CPU/memory metrics
  ::

  ::card{icon="i-lucide-file-code" title="serviceaccount_test.yaml"}
  **5 tests** - ServiceAccount creation, custom name, annotations
  ::

  ::card{icon="i-lucide-file-code" title="cacerts_test.yaml"}
  **5 tests** - CA certificates ConfigMap, inline certificates, multiple certs
  ::

  ::card{icon="i-lucide-file-code" title="gateway_test.yaml"}
  **7 tests** - Istio Gateway/VirtualService, gateways, hosts, HTTP routes
  ::

  ::card{icon="i-lucide-file-code" title="helpers_test.yaml"}
  **14 tests** - Database helpers (host, port, name, username), Bitnami overrides, labels
  ::
::

## Example Tests

### Testing Database Abstraction

The ConfigMap tests verify that database configuration works correctly for both embedded and external databases:

```yaml
# Test embedded PostgreSQL (default)
- it: should set DATABASE_HOST to embedded PostgreSQL service by default
  asserts:
    - equal:
        path: data.DATABASE_HOST
        value: RELEASE-NAME-heimdall-postgresql

# Test external database
- it: should use external database host when postgresql.enabled=false
  set:
    postgresql.enabled: false
    externalDatabase.host: external-db.example.com
    externalDatabase.database: heimdall_prod
    externalDatabase.username: heimdall_user
  asserts:
    - equal:
        path: data.DATABASE_HOST
        value: external-db.example.com
    - equal:
        path: data.DATABASE_NAME
        value: heimdall_prod
```

### Testing Secrets Priority

The secrets tests validate the three-approach priority system:

```yaml
# Test 1: Existing secret (highest priority - no secret created)
- it: should NOT create Secret when existingSecret is specified
  set:
    heimdall.existingSecret: my-existing-secret
  asserts:
    - hasDocuments:
        count: 0

# Test 2: Inline secrets override file-based secrets
- it: should prefer inline secrets over file-based secrets
  set:
    heimdall.secrets.jwtSecret: "inline_jwt_priority_test"
    heimdall.secretsFiles:
      - env/heimdall-secrets.yaml
  asserts:
    - equal:
        path: stringData.jwtSecret
        value: "inline_jwt_priority_test"
```

### Testing CA Certificates

The CA certs tests verify conditional NODE_EXTRA_CA_CERTS injection:

```yaml
# Test disabled state (no env var)
- it: should NOT set NODE_EXTRA_CA_CERTS when extraCertificates disabled
  set:
    extraCertificates.enabled: false
  asserts:
    - notContains:
        path: spec.template.spec.containers[0].env
        content:
          name: NODE_EXTRA_CA_CERTS

# Test enabled state (env var set)
- it: should set NODE_EXTRA_CA_CERTS when extraCertificates enabled
  set:
    extraCertificates.enabled: true
  asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: NODE_EXTRA_CA_CERTS
          value: /usr/local/share/ca-certificates/ca-bundle.pem
```

## Bugs Discovered and Fixed

Unit testing uncovered three production bugs during development:

::callout{icon="i-lucide-bug" color="red"}
**Bug 1: Duplicate DATABASE_* Keys in ConfigMap**

ConfigMap template and `env/heimdallconfig.yaml` both set `DATABASE_NAME`, `DATABASE_USERNAME`, `DATABASE_PORT` creating invalid YAML with duplicate keys.

**Fix**: Removed duplicate keys from env file, template helpers now manage these values.
::

::callout{icon="i-lucide-bug" color="red"}
**Bug 2: Wrong Helper Path**

`databaseHost` helper was checking `.Values.databaseHost` instead of `.Values.externalDatabase.host`.

**Fix**: Corrected helper to use `.Values.externalDatabase.host` when `postgresql.enabled=false`.
::

::callout{icon="i-lucide-bug" color="red"}
**Bug 3: Duplicate EXTERNAL_URL**

`EXTERNAL_URL` was being set in both template logic and override section, creating duplicate keys.

**Fix**: Filtered `EXTERNAL_URL` from override loop since it's managed by template logic.
::

## Running Tests Locally

### Basic Test Run

```bash
# Run all tests
helm unittest ./heimdall

# Expected output:
# Charts:      1 passed, 1 total
# Test Suites: 11 passed, 11 total
# Tests:       92 passed, 92 total
# Time:        ~850ms
```

### Run Specific Tests

```bash
# Test only StatefulSet
helm unittest ./heimdall -f tests/statefulset_test.yaml

# Test only database-related templates
helm unittest ./heimdall -f 'tests/*{configmap,helpers,statefulset}*'
```

### Verbose Output

```bash
# Show detailed test execution
helm unittest ./heimdall -v
```

## Pre-Commit Testing Checklist

Before committing changes to the chart:

- [ ] `helm lint ./heimdall --strict` passes
- [ ] `helm template heimdall ./heimdall` renders without errors
- [ ] `helm unittest ./heimdall` passes (all 92 tests)
- [ ] `kubectl apply --dry-run=client` validates successfully

```bash
# Run all pre-commit checks
helm lint ./heimdall --strict && \
  helm template heimdall ./heimdall > /dev/null && \
  helm unittest ./heimdall && \
  helm template heimdall ./heimdall | kubectl apply --dry-run=client -f -
```

## Future Testing Enhancements

Planned additions to the testing framework:

::steps
### Integration Testing with chart-testing (ct)

Use Helm's official [chart-testing](https://github.com/helm/chart-testing) tool with KIND clusters for integration testing.

```bash
ct lint-and-install --charts ./heimdall
```

### Policy Testing with Conftest

Add OPA policies to enforce security and compliance:

```bash
conftest test -p policy/ ./heimdall/
```

**Policies to enforce:**
- No hardcoded secrets
- Resource limits required
- Security contexts enabled
- Non-root containers

### End-to-End Testing with Terratest

For complex scenarios like OAuth flows, multi-replica deployments, and custom CA certificates.
::

## CI/CD Integration

The unit tests integrate seamlessly into GitHub Actions:

```yaml
jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install helm-unittest
        run: helm plugin install https://github.com/helm-unittest/helm-unittest

      - name: Run tests
        run: helm unittest ./heimdall
```

## References

::card-group
  ::card{icon="i-lucide-book" title="helm-unittest Documentation" to="https://github.com/helm-unittest/helm-unittest"}
  Official documentation for the helm-unittest plugin
  ::

  ::card{icon="i-lucide-book" title="Helm Testing Best Practices" to="https://helm.sh/docs/topics/chart_tests/"}
  Official Helm documentation on chart testing
  ::

  ::card{icon="i-lucide-book" title="Bitnami Testing Guide" to="https://github.com/bitnami/charts/blob/main/TESTING.md"}
  Production testing strategy from Bitnami charts
  ::
::
