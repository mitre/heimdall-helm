---
title: Chart Architecture
description: Technical architecture, design decisions, and implementation details
navigation:
  icon: i-lucide-layers
---

This page documents the technical architecture and key design decisions in the Heimdall Helm chart modernization.

## Chart Version History

### v3.3.3 (Legacy)

Original chart with standalone PostgreSQL deployment:

- Manual PostgreSQL StatefulSet
- Manual Service and PVC templates
- Individual `env` entries (482-line StatefulSet)
- SOPS-focused secrets management
- No values schema validation

### v0.3.0 (Current Development)

Modernized chart following Helm v4 and Bitnami best practices:

- Bitnami PostgreSQL subchart dependency
- Three-approach secrets management
- ConfigMap with `envFrom` pattern (168-line StatefulSet)
- JSON Schema validation (95+ variables)
- Database abstraction helpers

::tip
**Reduction**: StatefulSet reduced from **482 lines to 168 lines** (65% reduction, -314 lines).
::

## Architecture Diagrams

### Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │               Heimdall Namespace                       │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │                                                         │  │
│  │  ┌─────────────────┐      ┌──────────────────┐        │  │
│  │  │   Ingress       │      │  Service         │        │  │
│  │  │  (Optional)     │─────▶│  ClusterIP:3000  │        │  │
│  │  └─────────────────┘      └────────┬─────────┘        │  │
│  │                                     │                   │  │
│  │                            ┌────────▼─────────┐        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  ┌────────────┐  │        │  │
│  │                            │  │ Heimdall   │  │        │  │
│  │                            │  │ Pod 1      │  │        │  │
│  │                            │  └────────────┘  │        │  │
│  │                            │       │          │        │  │
│  │                            └───────┼──────────┘        │  │
│  │                                    │                   │  │
│  │  ┌──────────────────┐      ┌──────▼──────────┐        │  │
│  │  │  ConfigMap       │      │  Secret          │        │  │
│  │  │  (env vars)      │      │  (credentials)   │        │  │
│  │  └──────────────────┘      └─────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PostgreSQL      │        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  (Bitnami)       │        │  │
│  │                            └──────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PVC             │        │  │
│  │                            │  (Database)      │        │  │
│  │                            └──────────────────┘        │  │
│  │                                                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### Secrets Management Flow

```
┌──────────────────────────────────────────────────────────┐
│              Secrets Management Priority                  │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  1. existingSecret (Production)                           │
│     ┌──────────────────────────────────┐                 │
│     │  External Secrets Operator       │                 │
│     │  Sealed Secrets                  │                 │
│     │  Vault                           │                 │
│     │  AWS Secrets Manager             │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Pre-existing)                    │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  2. secretsFiles (Development)                            │
│     ┌──────────────────────────────────┐                 │
│     │  env/heimdall-secrets.yaml       │                 │
│     │  (Gitignored, 0600 permissions)  │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Helm Template Rendering           │                  │
│  │  {{ .Files.Get "path" }}           │                  │
│  └────────────┬─────────────────────┘                    │
│               │                                           │
│               ▼                                           │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  3. secrets (CI/CD)                                       │
│     ┌──────────────────────────────────┐                 │
│     │  values.yaml or --set flags      │                 │
│     │  (From env vars / vault CLI)     │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

## Template Structure

### File Organization

```
heimdall/templates/
├── _helpers.tpl                    # Template functions
├── NOTES.txt                       # Post-install instructions
├── configmap.yaml                  # Environment variables
├── heimdall-secrets.yaml           # Secrets (three approaches)
├── heimdall-statefulset.yaml       # Main application
├── heimdall-service.yaml           # ClusterIP service
├── ingress.yaml                    # Optional HTTP/HTTPS
├── db-migrate-job.yaml             # Sequelize migrations (TODO)
├── admin-user-job.yaml             # Admin creation (TODO)
└── (legacy PostgreSQL files)       # To be removed in Phase 2
```

### Template Dependencies

```
_helpers.tpl
    ├── heimdall.fullname
    ├── heimdall.labels
    ├── heimdall.selectorLabels
    └── Database helpers
        ├── heimdall.databaseHost
        ├── heimdall.databasePort
        ├── heimdall.databaseName
        └── heimdall.databaseUsername

configmap.yaml
    ├── Uses: heimdall.databaseHost
    ├── Uses: heimdall.databasePort
    ├── Uses: heimdall.databaseName
    ├── Uses: heimdall.databaseUsername
    ├── Loads: env/heimdallconfig.yaml
    └── Merges: .Values.heimdall.config

heimdall-secrets.yaml
    ├── Priority 1: .Values.heimdall.existingSecret
    ├── Priority 2: .Values.heimdall.secrets
    └── Priority 3: .Values.heimdall.secretsFiles

heimdall-statefulset.yaml
    ├── Uses: heimdall.fullname
    ├── Uses: heimdall.labels
    ├── Uses: heimdall.selectorLabels
    ├── envFrom: ConfigMap
    └── envFrom: Secret
```

## envFrom Pattern

### Before (Individual env entries)

```yaml [Old approach - 337 lines]
env:
  - name: NODE_ENV
    value: {{ .Values.nodeEnv | quote }}
  - name: DATABASE_HOST
    value: {{ include "heimdall.databaseHost" . | quote }}
  - name: DATABASE_PORT
    value: {{ include "heimdall.databasePort" . | quote }}
  # ... 334 more individual env entries ...
```

### After (envFrom pattern)

```yaml [New approach - 23 lines]
envFrom:
  - configMapRef:
      name: {{ include "heimdall.fullname" . }}-config
  - secretRef:
      name: {{ ternary .Values.heimdall.existingSecret ... }}
env:
  # Only special cases
  {{- if .Values.certs.enabled }}
  - name: NODE_EXTRA_CA_CERTS
    value: /home/node/certs/certs.pem
  {{- end }}
```

::tip
**Benefits**: Cleaner templates, easier maintenance, follows Kubernetes best practices.
::

## Design Decisions

### Why Bitnami PostgreSQL Subchart?

::field-group
  ::field{name="Battle-tested"}
  Millions of deployments in production
  ::
  ::field{name="Feature-rich"}
  Built-in HA, backup/restore, metrics, monitoring
  ::
  ::field{name="Well-maintained"}
  Regular security updates and bug fixes
  ::
  ::field{name="Consistent"}
  Follows same patterns as other MITRE SAF charts (Vulcan)
  ::
::

### Why Three Secrets Approaches?

Different deployment scenarios require different workflows:

- **existingSecret**: Production with GitOps, external secret managers
- **secretsFiles**: Development with local testing, quick iteration
- **secrets**: CI/CD with environment injection, automated deployments

### Why envFrom Instead of Individual env?

::card-group
  ::card{icon="i-lucide-check" title="Pros"}
  - 65% code reduction
  - Easier to maintain
  - Follows Kubernetes patterns
  - Cleaner templates
  ::
  ::card{icon="i-lucide-info" title="Trade-offs"}
  - All ConfigMap keys become env vars
  - Harder to override individual vars
  - Need to namespace keys properly
  ::
::

### Why Template Helpers for Database?

Abstraction enables easy switching between deployment modes:

```yaml
# Development - Embedded database
postgresql:
  enabled: true

# Production - AWS RDS
postgresql:
  enabled: false
externalDatabase:
  host: db.example.com
```

Templates automatically adjust without modification.

## Helm v4 Compatibility

The chart is compatible with both Helm v3 and v4:

::field-group
  ::field{name="Server-Side Apply (SSA)"}
  Default in Helm v4, automatic benefits
  ::
  ::field{name="Content-based caching"}
  Faster chart operations
  ::
  ::field{name="Backwards compatibility"}
  Works with Helm 3.x (tested with 3.12+)
  ::
  ::field{name="No breaking changes"}
  Templates don't require modification
  ::
::

## Migration Phases

### Phase 0: Baseline (Skipped)

Baseline testing of v3.3.3 was skipped to accelerate modernization.

### Phase 1: Foundation (✅ Complete)

- ✅ Chart structure and naming
- ✅ Template helpers for database abstraction
- ✅ Values.schema.json validation
- ✅ Three-approach secrets management
- ✅ ConfigMap with envFrom pattern
- ✅ StatefulSet simplification

### Phase 2: Database & Persistence (⏳ In Progress)

- ⏳ Bitnami PostgreSQL subchart integration
- ⏳ Database migration job (Helm hooks)
- ⏳ Init containers for readiness
- ⏳ Persistent volume claim templates
- ⏳ Remove standalone PostgreSQL templates

### Phase 3: Health & HA (Pending)

- ❌ Startup/liveness/readiness probes
- ❌ PodDisruptionBudget
- ❌ HorizontalPodAutoscaler
- ❌ Resource requests/limits

### Phase 4: Network & Security (Pending)

- ❌ Ingress configuration
- ❌ NetworkPolicy templates
- ❌ ServiceMonitor (Prometheus)
- ❌ Security contexts

### Phase 5: Operations (Pending)

- ❌ Admin user creation job
- ❌ Backup/restore procedures
- ❌ Upgrade testing
- ❌ Chart documentation

### Phase 6: Testing (Pending)

- ❌ Helm test templates
- ❌ Integration tests
- ❌ Chart linting
- ❌ Values validation

### Phase 7: Release (Pending)

- ❌ CHANGELOG.md
- ❌ README.md generation
- ❌ Artifact Hub metadata
- ❌ GitHub release workflow

## Key Metrics

::field-group
  ::field{name="Code Reduction"}
  -314 lines in StatefulSet (65% reduction)
  ::
  ::field{name="Environment Variables"}
  95+ validated via JSON Schema Draft-07
  ::
  ::field{name="Secrets Approaches"}
  3 distinct methods for different scenarios
  ::
  ::field{name="Template Helpers"}
  4 database abstraction functions
  ::
  ::field{name="Helm Version"}
  Compatible with v3.x and v4.x
  ::
::

## Next Steps

::card-group
  ::card{icon="i-lucide-database" title="Database Setup" to="/helm-chart/database"}
  Current Phase 2 work
  ::
  ::card{icon="i-lucide-key" title="Secrets Management" to="/helm-chart/secrets"}
  Production-ready approaches
  ::
::
