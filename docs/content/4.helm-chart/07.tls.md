---
title: TLS/SSL Configuration
description: Configure HTTPS certificates for Heimdall
---

## Overview

Heimdall supports two approaches for TLS/SSL certificates:
1. **Automated** - cert-manager with Let's Encrypt (recommended for internet-facing deployments)
2. **Manual** - Existing certificates (DoD PKI, MITRE certs, corporate CA, purchased certificates)

Both use the same `ingress.tls` configuration structure.

## Prerequisites

- Ingress controller installed (Traefik, Nginx, etc.)
- Ingress enabled (`heimdall.ingress.enabled: true`)
- DNS configured to point to your ingress controller

## Approach 1: Automated (cert-manager)

### Benefits

- ✅ Automatic certificate issuance
- ✅ Automatic renewal (60 days before expiration)
- ✅ Supports Let's Encrypt, private CAs, Vault, Venafi
- ✅ No manual certificate management

### Installation

**Install cert-manager**:

```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
```

**Verify installation**:

```bash
kubectl get pods -n cert-manager
```

### Let's Encrypt Setup

#### Step 1: Create ClusterIssuer (Production)

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # Let's Encrypt production server
    server: https://acme-v02.api.letsencrypt.org/directory

    # Email for expiration notices
    email: admin@example.com

    # Secret to store ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod

    # HTTP-01 challenge solver
    solvers:
    - http01:
        ingress:
          class: traefik  # or nginx, alb, etc.
```

**Apply**:

```bash
kubectl apply -f clusterissuer.yaml
```

#### Step 2: Create ClusterIssuer (Staging for Testing)

Always test with staging first to avoid rate limits.

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    # Let's Encrypt staging server (rate limits are relaxed)
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: traefik
```

#### Step 3: Configure Heimdall Chart

```yaml
heimdall:
  ingress:
    enabled: true
    className: "traefik"
    annotations:
      # Tell cert-manager to issue certificate
      cert-manager.io/cluster-issuer: "letsencrypt-prod"

    hosts:
      - host: heimdall.example.com
        paths:
          - path: /
            pathType: Prefix

    tls:
      # cert-manager will create this secret automatically
      - secretName: heimdall-tls
        hosts:
          - heimdall.example.com
```

#### Step 4: Deploy Chart

```bash
helm install heimdall ./heimdall -n heimdall --create-namespace -f values.yaml
```

cert-manager will:
1. Detect the `cert-manager.io/cluster-issuer` annotation
2. Create a Certificate resource
3. Perform HTTP-01 challenge with Let's Encrypt
4. Store certificate in `heimdall-tls` secret
5. Automatically renew 60 days before expiration

#### Step 5: Verify Certificate

**Check Certificate resource**:

```bash
kubectl get certificate -n heimdall
# Should show: READY=True
```

**Check certificate details**:

```bash
kubectl describe certificate heimdall-tls -n heimdall
```

**View certificate expiration**:

```bash
kubectl get secret heimdall-tls -n heimdall -o jsonpath='{.data.tls\.crt}' | \
  base64 -d | openssl x509 -noout -dates
```

### DNS-01 Challenge (Wildcard Certificates)

For wildcard certificates (e.g., `*.example.com`), use DNS-01 challenge:

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-dns
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@example.com
    privateKeySecretRef:
      name: letsencrypt-dns
    solvers:
    # Route53 (AWS)
    - dns01:
        route53:
          region: us-east-1
          accessKeyID: AKIAIOSFODNN7EXAMPLE
          secretAccessKeySecretRef:
            name: route53-credentials
            key: secret-access-key

    # CloudDNS (Google Cloud)
    # - dns01:
    #     cloudDNS:
    #       project: my-project
    #       serviceAccountSecretRef:
    #         name: clouddns-credentials
    #         key: key.json

    # Cloudflare
    # - dns01:
    #     cloudflare:
    #       email: admin@example.com
    #       apiTokenSecretRef:
    #         name: cloudflare-api-token
    #         key: api-token
```

Then configure wildcard host:

```yaml
heimdall:
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-dns"
    hosts:
      - host: heimdall.example.com
    tls:
      - secretName: heimdall-wildcard-tls
        hosts:
          - "*.example.com"
```

## Approach 2: Manual Certificates

### Use Cases

- DoD PKI certificates
- MITRE corporate certificates
- Government CA certificates
- Purchased certificates (DigiCert, Comodo, etc.)
- Internal CA certificates

### Step 1: Obtain Certificate Files

You should have:
- **Certificate**: `tls.crt` (or `cert.pem`)
- **Private Key**: `tls.key` (or `key.pem`)
- **CA Bundle** (optional): `ca-bundle.crt`

**If you have a certificate chain**, combine them:

```bash
# Create fullchain (cert + intermediate + root)
cat cert.crt intermediate.crt root.crt > fullchain.crt
```

### Step 2: Create TLS Secret

**From files**:

```bash
kubectl create secret tls heimdall-tls \
  --cert=fullchain.crt \
  --key=tls.key \
  -n heimdall
```

**From base64-encoded values**:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: heimdall-tls
  namespace: heimdall
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...  # Base64 encoded certificate
  tls.key: LS0tLS1CRUdJTi...  # Base64 encoded private key
```

**Verify secret**:

```bash
kubectl get secret heimdall-tls -n heimdall
kubectl describe secret heimdall-tls -n heimdall
```

### Step 3: Configure Heimdall Chart

```yaml
heimdall:
  ingress:
    enabled: true
    className: "traefik"
    hosts:
      - host: heimdall.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: heimdall-tls  # Pre-created secret
        hosts:
          - heimdall.example.com
```

### Step 4: Deploy Chart

```bash
helm install heimdall ./heimdall -n heimdall --create-namespace -f values.yaml
```

### Certificate Renewal

::callout{icon="i-heroicons-exclamation-triangle" color="amber"}
**Manual certificates do not auto-renew.** Set calendar reminders before expiration.
::

**Check expiration date**:

```bash
kubectl get secret heimdall-tls -n heimdall -o jsonpath='{.data.tls\.crt}' | \
  base64 -d | openssl x509 -noout -enddate
```

**Renew certificate** (before expiration):

```bash
# 1. Delete old secret
kubectl delete secret heimdall-tls -n heimdall

# 2. Create new secret with renewed certificate
kubectl create secret tls heimdall-tls \
  --cert=new-cert.crt \
  --key=new-key.key \
  -n heimdall

# 3. Restart pods to pick up new certificate (if needed)
kubectl rollout restart statefulset heimdall -n heimdall
```

## DoD/Government Certificates

### DoD PKI Certificates

**Typical structure**:
- Server certificate: `server.cer`
- Private key: `server.key` (encrypted)
- CA chain: `ca-bundle.cer`

**Decrypt private key** (if encrypted):

```bash
openssl rsa -in server.key.encrypted -out server.key
```

**Combine certificate chain**:

```bash
cat server.cer dod-intermediate-ca.cer dod-root-ca.cer > fullchain.crt
```

**Create secret**:

```bash
kubectl create secret tls heimdall-dod-tls \
  --cert=fullchain.crt \
  --key=server.key \
  -n heimdall
```

**Configure chart**:

```yaml
heimdall:
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    hosts:
      - host: heimdall.navy.mil
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: heimdall-dod-tls
        hosts:
          - heimdall.navy.mil
```

### MITRE Corporate Certificates

MITRE-issued certificates follow similar process:

```bash
kubectl create secret tls heimdall-mitre-tls \
  --cert=mitre-cert-chain.crt \
  --key=mitre-key.key \
  -n heimdall
```

## Troubleshooting

### Certificate Not Applied

**Check ingress**:

```bash
kubectl get ingress -n heimdall -o yaml | grep -A5 tls
```

**Check secret exists**:

```bash
kubectl get secret heimdall-tls -n heimdall
```

**Check secret is type kubernetes.io/tls**:

```bash
kubectl get secret heimdall-tls -n heimdall -o jsonpath='{.type}'
```

### cert-manager Certificate Pending

**Check Certificate resource**:

```bash
kubectl describe certificate heimdall-tls -n heimdall
```

Look for:
- `Issuing certificate as Secret does not exist`
- `Waiting for CertificateRequest`
- HTTP-01 challenge status

**Check CertificateRequest**:

```bash
kubectl get certificaterequest -n heimdall
kubectl describe certificaterequest <name> -n heimdall
```

**Check Challenge** (HTTP-01):

```bash
kubectl get challenge -n heimdall
kubectl describe challenge <name> -n heimdall
```

**Common issues**:
- Ingress controller not routing `/.well-known/acme-challenge/` correctly
- DNS not pointing to ingress controller
- Firewall blocking port 80 (required for HTTP-01)

### Browser Certificate Warnings

**"Your connection is not private"**:

1. **Check certificate matches hostname**:

```bash
kubectl get secret heimdall-tls -n heimdall -o jsonpath='{.data.tls\.crt}' | \
  base64 -d | openssl x509 -noout -text | grep -A1 "Subject Alternative Name"
```

Should show your hostname (e.g., `heimdall.example.com`)

2. **Check certificate is valid**:

```bash
kubectl get secret heimdall-tls -n heimdall -o jsonpath='{.data.tls\.crt}' | \
  base64 -d | openssl x509 -noout -dates
```

3. **Check certificate chain is complete**:

Missing intermediate certificates cause browser warnings.

```bash
# Test certificate chain
openssl s_client -connect heimdall.example.com:443 -showcerts
```

### Let's Encrypt Rate Limits

**Problem**: Hit Let's Encrypt production rate limits

**Solution**: Use staging issuer for testing

```yaml
annotations:
  cert-manager.io/cluster-issuer: "letsencrypt-staging"  # Not prod
```

Staging certificates will show browser warnings but verify your setup works.

Once confirmed, switch to production issuer:

```yaml
annotations:
  cert-manager.io/cluster-issuer: "letsencrypt-prod"
```

Then delete the staging certificate to force renewal:

```bash
kubectl delete certificate heimdall-tls -n heimdall
kubectl delete secret heimdall-tls -n heimdall
```

## Common Scenarios

### Local Development (Self-Signed)

```bash
# Generate self-signed certificate
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=heimdall.local/O=Development"

# Create secret
kubectl create secret tls heimdall-dev-tls \
  --cert=tls.crt --key=tls.key -n heimdall
```

```yaml
heimdall:
  ingress:
    enabled: true
    hosts:
      - host: heimdall.local
    tls:
      - secretName: heimdall-dev-tls
        hosts:
          - heimdall.local
```

### Production Internet-Facing (Let's Encrypt)

```yaml
heimdall:
  ingress:
    enabled: true
    className: "traefik"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
    hosts:
      - host: heimdall.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: heimdall-tls
        hosts:
          - heimdall.example.com
```

### Production Internal (Corporate CA)

```yaml
heimdall:
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - host: heimdall.internal.corp
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: heimdall-corp-tls  # Pre-created with corp cert
        hosts:
          - heimdall.internal.corp
```

## See Also

- [Ingress Configuration](./8.ingress.md) - Ingress controller setup
- [cert-manager Documentation](https://cert-manager.io/docs/) - Official cert-manager docs
- [Let's Encrypt Rate Limits](https://letsencrypt.org/docs/rate-limits/) - Production limits
