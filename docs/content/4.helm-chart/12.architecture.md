---
title: Chart Architecture
description: Technical architecture, design decisions, and implementation details
navigation:
  icon: i-lucide-layers
---

This page documents the technical architecture and key design decisions in the Heimdall Helm chart modernization.

## Chart Version History

### v3.3.3 (Legacy)

Original chart with standalone PostgreSQL deployment:

- Manual PostgreSQL StatefulSet
- Manual Service and PVC templates
- Individual `env` entries (482-line StatefulSet)
- SOPS-focused secrets management
- No values schema validation

### v1.0.0 (Current)

Modernized chart following Helm v4 and Bitnami best practices:

- Bitnami PostgreSQL subchart dependency
- Three-approach secrets management
- ConfigMap with `envFrom` pattern (168-line StatefulSet)
- JSON Schema validation (95+ variables)
- Database abstraction helpers

::tip
**Reduction**: StatefulSet reduced from **482 lines to 168 lines** (65% reduction, -314 lines).
::

## Architecture Diagrams

### Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Kubernetes Cluster                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Heimdall Namespace                       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚   Ingress       â”‚      â”‚  Service         â”‚        â”‚  â”‚
â”‚  â”‚  â”‚  (Optional)     â”‚â”€â”€â”€â”€â”€â–¶â”‚  ClusterIP:3000  â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                     â”‚                   â”‚  â”‚
â”‚  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚                            â”‚  StatefulSet     â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  â”‚ Heimdall   â”‚  â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  â”‚ Pod 1      â”‚  â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚       â”‚          â”‚        â”‚  â”‚
â”‚  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                    â”‚                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚  â”‚  ConfigMap       â”‚      â”‚  Secret          â”‚        â”‚  â”‚
â”‚  â”‚  â”‚  (env vars)      â”‚      â”‚  (credentials)   â”‚        â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                    â”‚                   â”‚  â”‚
â”‚  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚                            â”‚  PostgreSQL      â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  StatefulSet     â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  (Bitnami)       â”‚        â”‚  â”‚
â”‚  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                    â”‚                   â”‚  â”‚
â”‚  â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚                            â”‚  PVC             â”‚        â”‚  â”‚
â”‚  â”‚                            â”‚  (Database)      â”‚        â”‚  â”‚
â”‚  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Secrets Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Secrets Management Priority                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  1. existingSecret (Production)                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚     â”‚  External Secrets Operator       â”‚                 â”‚
â”‚     â”‚  Sealed Secrets                  â”‚                 â”‚
â”‚     â”‚  Vault                           â”‚                 â”‚
â”‚     â”‚  AWS Secrets Manager             â”‚                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                  â”‚                                        â”‚
â”‚                  â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Kubernetes Secret                 â”‚                  â”‚
â”‚  â”‚  (Pre-existing)                    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                            â”‚
â”‚  2. secretsFiles (Development)                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚     â”‚  env/heimdall-secrets.yaml       â”‚                 â”‚
â”‚     â”‚  (Gitignored, 0600 permissions)  â”‚                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                  â”‚                                        â”‚
â”‚                  â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Helm Template Rendering           â”‚                  â”‚
â”‚  â”‚  {{ .Files.Get "path" }}           â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚               â”‚                                           â”‚
â”‚               â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Kubernetes Secret                 â”‚                  â”‚
â”‚  â”‚  (Created by chart)                â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                            â”‚
â”‚  3. secrets (CI/CD)                                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚     â”‚  values.yaml or --set flags      â”‚                 â”‚
â”‚     â”‚  (From env vars / vault CLI)     â”‚                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                  â”‚                                        â”‚
â”‚                  â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Kubernetes Secret                 â”‚                  â”‚
â”‚  â”‚  (Created by chart)                â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Template Structure

### File Organization

```
heimdall/templates/
â”œâ”€â”€ _helpers.tpl                    # Template functions
â”œâ”€â”€ NOTES.txt                       # Post-install instructions
â”œâ”€â”€ configmap.yaml                  # Environment variables
â”œâ”€â”€ heimdall-secrets.yaml           # Secrets (three approaches)
â”œâ”€â”€ heimdall-statefulset.yaml       # Main application
â”œâ”€â”€ heimdall-service.yaml           # ClusterIP service
â”œâ”€â”€ heimdall-serviceaccount.yaml    # ServiceAccount for pods
â”œâ”€â”€ ingress.yaml                    # Ingress (HTTP/HTTPS routing)
â”œâ”€â”€ gateway.yaml                    # Gateway API (alternative to Ingress)
â”œâ”€â”€ heimdall-cacerts-configmap.yaml # Custom CA certificates
â”œâ”€â”€ hpa.yaml                        # HorizontalPodAutoscaler
â”œâ”€â”€ poddisruptionbudget.yaml        # PodDisruptionBudget
â”œâ”€â”€ db-migrate-job.yaml             # Sequelize migrations (TODO - Phase 2)
â”œâ”€â”€ admin-user-job.yaml             # Admin creation (TODO - Phase 5)
â”œâ”€â”€ tests/                          # Helm test templates
â””â”€â”€ (PostgreSQL via Bitnami subchart - no local templates)
```

### Template Dependencies

```
_helpers.tpl
    â”œâ”€â”€ heimdall.fullname
    â”œâ”€â”€ heimdall.labels
    â”œâ”€â”€ heimdall.selectorLabels
    â””â”€â”€ Database helpers
        â”œâ”€â”€ heimdall.databaseHost
        â”œâ”€â”€ heimdall.databasePort
        â”œâ”€â”€ heimdall.databaseName
        â””â”€â”€ heimdall.databaseUsername

configmap.yaml
    â”œâ”€â”€ Uses: heimdall.databaseHost
    â”œâ”€â”€ Uses: heimdall.databasePort
    â”œâ”€â”€ Uses: heimdall.databaseName
    â”œâ”€â”€ Uses: heimdall.databaseUsername
    â”œâ”€â”€ Loads: env/heimdallconfig.yaml
    â””â”€â”€ Merges: .Values.heimdall.config

heimdall-secrets.yaml
    â”œâ”€â”€ Priority 1: .Values.heimdall.existingSecret
    â”œâ”€â”€ Priority 2: .Values.heimdall.secrets
    â””â”€â”€ Priority 3: .Values.heimdall.secretsFiles

heimdall-statefulset.yaml
    â”œâ”€â”€ Uses: heimdall.fullname
    â”œâ”€â”€ Uses: heimdall.labels
    â”œâ”€â”€ Uses: heimdall.selectorLabels
    â”œâ”€â”€ envFrom: ConfigMap
    â””â”€â”€ envFrom: Secret
```

## envFrom Pattern

### Before (Individual env entries)

```yaml [Old approach - 337 lines]
env:
  - name: NODE_ENV
    value: {{ .Values.nodeEnv | quote }}
  - name: DATABASE_HOST
    value: {{ include "heimdall.databaseHost" . | quote }}
  - name: DATABASE_PORT
    value: {{ include "heimdall.databasePort" . | quote }}
  # ... 334 more individual env entries ...
```

### After (envFrom pattern)

```yaml [New approach - 23 lines]
envFrom:
  - configMapRef:
      name: {{ include "heimdall.fullname" . }}-config
  - secretRef:
      name: {{ ternary .Values.heimdall.existingSecret ... }}
env:
  # Only special cases
  {{- if .Values.certs.enabled }}
  - name: NODE_EXTRA_CA_CERTS
    value: /home/node/certs/certs.pem
  {{- end }}
```

::tip
**Benefits**: Cleaner templates, easier maintenance, follows Kubernetes best practices.
::

## Design Decisions

### Why Bitnami PostgreSQL Subchart?

::field-group
  ::field{name="Battle-tested"}
  Millions of deployments in production
  ::
  ::field{name="Feature-rich"}
  Built-in HA, backup/restore, metrics, monitoring
  ::
  ::field{name="Well-maintained"}
  Regular security updates and bug fixes
  ::
  ::field{name="Consistent"}
  Follows same patterns as other MITRE SAF charts (Vulcan)
  ::
::

### Why Three Secrets Approaches?

Different deployment scenarios require different workflows:

- **existingSecret**: Production with GitOps, external secret managers
- **secretsFiles**: Development with local testing, quick iteration
- **secrets**: CI/CD with environment injection, automated deployments

### Why envFrom Instead of Individual env?

::card-group
  ::card{icon="i-lucide-check" title="Pros"}
  - 65% code reduction
  - Easier to maintain
  - Follows Kubernetes patterns
  - Cleaner templates
  ::
  ::card{icon="i-lucide-info" title="Trade-offs"}
  - All ConfigMap keys become env vars
  - Harder to override individual vars
  - Need to namespace keys properly
  ::
::

### Why Template Helpers for Database?

Abstraction enables easy switching between deployment modes:

```yaml
# Development - Embedded database
postgresql:
  enabled: true

# Production - AWS RDS
postgresql:
  enabled: false
externalDatabase:
  host: db.example.com
```

Templates automatically adjust without modification.

## Helm v4 Compatibility

The chart is compatible with both Helm v3 and v4:

::field-group
  ::field{name="Server-Side Apply (SSA)"}
  Default in Helm v4, automatic benefits
  ::
  ::field{name="Content-based caching"}
  Faster chart operations
  ::
  ::field{name="Backwards compatibility"}
  Works with Helm 3.x (tested with 3.12+)
  ::
  ::field{name="No breaking changes"}
  Templates don't require modification
  ::
::

## Migration Phases

### Phase 0: Baseline (Skipped)

Baseline testing of v3.3.3 was skipped to accelerate modernization.

### Phase 1: Foundation (âœ… Complete)

- âœ… Chart structure and naming
- âœ… Template helpers for database abstraction
- âœ… Values.schema.json validation
- âœ… Three-approach secrets management
- âœ… ConfigMap with envFrom pattern
- âœ… StatefulSet simplification

### Phase 2: Database & Persistence (âœ… Complete)

- âœ… Bitnami PostgreSQL subchart integration
- âœ… Database init container for readiness checking
- âœ… Persistent volume support via Bitnami subchart
- ğŸ“‹ Database migration Helm hooks (planned)
- âœ… Removed standalone PostgreSQL templates

### Phase 3: Health & HA (âœ… Complete)

- âœ… Startup/liveness/readiness probes
- âœ… PodDisruptionBudget
- âœ… HorizontalPodAutoscaler
- âœ… Resource requests/limits
- âœ… Init container for database readiness

### Phase 4: Network & Security (ğŸš§ In Progress)

- âœ… Ingress configuration
- âŒ NetworkPolicy templates (planned)
- âŒ ServiceMonitor (Prometheus) (planned)
- âœ… Security contexts
- âœ… Custom CA certificates

### Phase 5: Operations (ğŸ“‹ Planned)

- âŒ Admin user creation job
- âŒ Backup/restore procedures
- âŒ Monitoring integration guides
- âœ… Chart documentation (Nuxt UI site)

### Phase 6: Testing (âœ… Complete)

- âœ… Helm test templates
- âœ… Integration tests (chart-testing)
- âœ… Chart linting (strict mode)
- âœ… Values validation (JSON Schema)
- âœ… Unit tests (helm-unittest, 92 tests)

### Phase 7: Release Automation (ğŸš§ In Progress)

- âŒ CHANGELOG.md automation
- âœ… README.md generation (helm-docs)
- âŒ Artifact Hub metadata
- âŒ GitHub release workflow (chart-releaser)

## Key Metrics

::field-group
  ::field{name="Code Reduction"}
  -314 lines in StatefulSet (65% reduction)
  ::
  ::field{name="Environment Variables"}
  95+ validated via JSON Schema Draft-07
  ::
  ::field{name="Secrets Approaches"}
  3 distinct methods for different scenarios
  ::
  ::field{name="Template Helpers"}
  4 database abstraction functions
  ::
  ::field{name="Helm Version"}
  Compatible with v3.x and v4.x
  ::
::

## Next Steps

::card-group
  ::card{icon="i-lucide-database" title="Database Setup" to="/helm-chart/database"}
  Embedded and external PostgreSQL
  ::
  ::card{icon="i-lucide-key" title="Secrets Management" to="/helm-chart/secrets"}
  Production-ready approaches
  ::
::
