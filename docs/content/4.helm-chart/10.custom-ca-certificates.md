---
title: Custom CA Certificates
description: Configure custom Certificate Authorities for corporate environments
---

## Overview

Heimdall supports custom CA (Certificate Authority) certificates for environments that use:
- Corporate MITM (Man-in-the-Middle) proxies
- Internal APIs with self-signed certificates
- Private container registries
- DoD or government certificate authorities
- Air-gapped networks with custom PKI

## How It Works

The chart uses a three-step approach to support multiple CA certificates:

1. **Storage**: Individual certificates stored in a Kubernetes ConfigMap (`.crt` or `.pem` files)
2. **Concatenation**: Init container concatenates all certificates into a single `ca-bundle.pem` file
3. **Injection**: `NODE_EXTRA_CA_CERTS` environment variable points Node.js to the bundle file

::callout{icon="i-heroicons-information-circle" color="blue"}
**Why concatenate?** Node.js's `NODE_EXTRA_CA_CERTS` requires a single file path, not a directory. The chart automatically handles concatenation so you can provide multiple certificates.
::

## Configuration

### Approach 1: Inline Certificates (Development)

Provide certificates directly in `values.yaml`:

```yaml
extraCertificates:
  enabled: true
  certificates:
    mitre-ca.crt: |
      -----BEGIN CERTIFICATE-----
      MIIDXTCCAkWgAwIBAgIJAKJ5hWlb3K9LQMA0GCSqGSIb3DQEBBQUAMF
      ... (certificate content) ...
      -----END CERTIFICATE-----

    dod-root.crt: |
      -----BEGIN CERTIFICATE-----
      MIIEFzCCAv+gAwIBAgIQB/LhWZqYL2uIbF7RP7HIXDA...
      ... (certificate content) ...
      -----END CERTIFICATE-----
```

The chart will:
- Create a ConfigMap named `heimdall-ca-certs`
- Concatenate both certificates into `/usr/local/share/ca-certificates/ca-bundle.pem`
- Set `NODE_EXTRA_CA_CERTS` to the bundle path

### Approach 2: Existing ConfigMap (Production)

Create the ConfigMap separately (recommended for production):

```bash
# Create ConfigMap from certificate files
kubectl create configmap custom-ca-certs \
  --from-file=mitre-ca.crt \
  --from-file=dod-root.crt \
  --from-file=corporate-intermediate.pem \
  -n heimdall
```

Then reference it in `values.yaml`:

```yaml
extraCertificates:
  enabled: true
  configMapName: "custom-ca-certs"
```

## Use Cases

### Corporate MITM Proxy

Organizations often use SSL-intercepting proxies for security scanning:

```yaml
extraCertificates:
  enabled: true
  certificates:
    corporate-proxy.crt: |
      -----BEGIN CERTIFICATE-----
      MIIDdzCCAl+gAwIBAgIEAgAAuTANBgkqhk...
      -----END CERTIFICATE-----
```

### DoD PKI Certificates

For Department of Defense deployments:

```bash
# Download DoD certificates
wget https://dl.dod.cyber.mil/wp-content/uploads/pki-pke/zip/unclass-dod_approved_external_pkis_trust_chains.zip
unzip unclass-dod_approved_external_pkis_trust_chains.zip

# Create ConfigMap
kubectl create configmap dod-ca-bundle \
  --from-file=DoD_Root_CA_3.cer \
  --from-file=DoD_Root_CA_4.cer \
  --from-file=DoD_Root_CA_5.cer \
  -n heimdall
```

```yaml
extraCertificates:
  enabled: true
  configMapName: "dod-ca-bundle"
```

### Internal API with Self-Signed Certificate

For testing with internal services:

```bash
# Export certificate from internal API
openssl s_client -connect internal-api.corp:443 -showcerts < /dev/null 2>/dev/null | \
  openssl x509 -outform PEM > internal-api.crt

# Create ConfigMap
kubectl create configmap internal-api-ca \
  --from-file=internal-api.crt \
  -n heimdall
```

```yaml
extraCertificates:
  enabled: true
  configMapName: "internal-api-ca"
```

### Private Container Registry

For pulling images from a registry with custom CA:

```yaml
extraCertificates:
  enabled: true
  certificates:
    registry-ca.crt: |
      -----BEGIN CERTIFICATE-----
      MIIC+DCCAeCgAwIBAgIJAIWp8QLZ4...
      -----END CERTIFICATE-----
```

## Certificate Formats

### Supported Formats

- **PEM** (`.pem`, `.crt`) - Recommended, widely supported
- **Base64-encoded** - Same as PEM

### File Extensions

Both `.crt` and `.pem` extensions are supported. The init container concatenates all files matching these patterns:

```bash
cat /tmp/ca-source/*.crt /tmp/ca-source/*.pem > /tmp/ca-certs/ca-bundle.pem
```

### Converting from DER to PEM

If you have certificates in DER format (`.cer`, `.der`):

```bash
openssl x509 -inform DER -in certificate.cer -out certificate.pem -outform PEM
```

## Verification

### Check ConfigMap Created

```bash
kubectl get configmap -n heimdall | grep ca-certs
```

### View ConfigMap Contents

```bash
# For inline certificates
kubectl get configmap heimdall-ca-certs -n heimdall -o yaml

# For existing ConfigMap
kubectl get configmap custom-ca-certs -n heimdall -o yaml
```

### Verify Init Container Ran

```bash
kubectl logs -n heimdall heimdall-0 -c concat-ca-certs
```

Expected output:
```
CA bundle created with 3 certificate(s)
```

### Check Environment Variable

```bash
kubectl exec -n heimdall heimdall-0 -- env | grep NODE_EXTRA_CA_CERTS
```

Expected output:
```
NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/ca-bundle.pem
```

### Verify Bundle File Exists

```bash
kubectl exec -n heimdall heimdall-0 -- ls -lh /usr/local/share/ca-certificates/
```

Expected output:
```
total 12K
-rw-r--r-- 1 root root 8.2K Dec 31 12:00 ca-bundle.pem
```

### Test Certificate Trust

```bash
# Test Node.js trusts the custom CA
kubectl exec -n heimdall heimdall-0 -- node -e "
const https = require('https');
https.get('https://internal-api.corp', (res) => {
  console.log('Success! Status:', res.statusCode);
}).on('error', (e) => {
  console.error('Error:', e.message);
});
"
```

## Troubleshooting

### Certificate Not Trusted

**Symptom**: `UNABLE_TO_VERIFY_LEAF_SIGNATURE` or `SELF_SIGNED_CERT_IN_CHAIN` errors

**Check bundle contents**:
```bash
kubectl exec -n heimdall heimdall-0 -- cat /usr/local/share/ca-certificates/ca-bundle.pem
```

**Verify certificate format**:
```bash
kubectl exec -n heimdall heimdall-0 -- openssl x509 -in /usr/local/share/ca-certificates/ca-bundle.pem -text -noout
```

**Common issues**:
- Certificate is in DER format instead of PEM
- Missing intermediate certificates
- Certificate expired
- Wrong certificate (not the root/intermediate CA)

### Init Container Failed

**Check init container logs**:
```bash
kubectl logs -n heimdall heimdall-0 -c concat-ca-certs
```

**Check ConfigMap exists**:
```bash
kubectl get configmap -n heimdall
```

**Verify ConfigMap has data**:
```bash
kubectl describe configmap heimdall-ca-certs -n heimdall
```

### No Certificates Concatenated

**Symptom**: Init container reports `CA bundle created with 0 certificate(s)`

**Causes**:
- ConfigMap is empty
- Certificate files don't have `.crt` or `.pem` extensions
- Certificate content is missing `BEGIN CERTIFICATE` marker

**Fix**:
```bash
# Check ConfigMap keys
kubectl get configmap heimdall-ca-certs -n heimdall -o jsonpath='{.data}' | jq 'keys'

# Ensure keys end with .crt or .pem
kubectl delete configmap heimdall-ca-certs -n heimdall
kubectl create configmap heimdall-ca-certs \
  --from-file=cert1.crt \
  --from-file=cert2.pem \
  -n heimdall
```

### Pod Stuck in Init

**Symptom**: Pod shows `Init:0/1` status indefinitely

**Debug**:
```bash
kubectl describe pod -n heimdall heimdall-0
kubectl logs -n heimdall heimdall-0 -c concat-ca-certs
```

**Common causes**:
- Init container image pull failure (check `imagePullSecrets`)
- Volume mount issues
- ConfigMap not found

## Best Practices

### Certificate Management

1. **Use existing ConfigMap in production** - Easier to rotate certificates without chart upgrades
2. **Name certificates descriptively** - Use `mitre-root-ca.crt` not `cert1.crt`
3. **Include full chain** - Root CA + intermediates if applicable
4. **Set expiration reminders** - Corporate CAs may expire

### Security

1. **Store in version control** - Certificates are public data (not secrets)
2. **Verify certificate sources** - Only trust certificates from official sources
3. **Use minimal certificates** - Only add what's necessary
4. **Audit usage** - Track which certificates are deployed where

### Operations

1. **Test in staging first** - Verify certificates before production
2. **Document certificate sources** - Where did each certificate come from?
3. **Automate rotation** - Use CI/CD to update ConfigMap when certificates renew
4. **Monitor expiration** - Set alerts 60-90 days before expiration

## Advanced Configuration

### Certificate Rotation Without Downtime

Update the ConfigMap and restart pods:

```bash
# Update ConfigMap
kubectl create configmap custom-ca-certs \
  --from-file=new-cert.crt \
  --dry-run=client -o yaml | kubectl apply -f -

# Restart StatefulSet (triggers init container to rebuild bundle)
kubectl rollout restart statefulset/heimdall -n heimdall
```

### Multiple Certificate Sources

Combine certificates from multiple ConfigMaps:

```bash
# Create combined ConfigMap
kubectl create configmap all-ca-certs -n heimdall --from-literal=placeholder=temp

# Add certificates from different sources
kubectl get configmap dod-certs -n heimdall -o json | \
  jq -r '.data | to_entries[] | .key + "\n" + .value' | \
  while read key; read value; do
    kubectl patch configmap all-ca-certs -n heimdall \
      --type merge -p "{\"data\":{\"$key\":\"$value\"}}"
  done
```

```yaml
extraCertificates:
  enabled: true
  configMapName: "all-ca-certs"
```

### Custom Init Container Image

For air-gapped environments, use your own image:

Edit `heimdall/templates/heimdall-statefulset.yaml`:

```yaml
initContainers:
  - name: concat-ca-certs
    image: registry.internal.corp/busybox:1.36  # Custom registry
    command:
      - sh
      - -c
      - |
        cat /tmp/ca-source/*.crt /tmp/ca-source/*.pem > /tmp/ca-certs/ca-bundle.pem 2>/dev/null || true
```

## See Also

- [TLS/SSL Configuration](./9.tls.md) - Ingress TLS certificates
- [Security Best Practices](./7.security.md) - Chart security configuration
- [Troubleshooting Guide](../5.troubleshooting/common-issues.md) - Certificate issues
