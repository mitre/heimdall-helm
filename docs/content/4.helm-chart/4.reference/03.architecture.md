---
title: Chart Architecture
description: Technical architecture, design decisions, and implementation details
navigation:
  icon: i-lucide-layers
---

This page documents the technical architecture and key design decisions in the Heimdall Helm chart modernization.

## Chart Version History

### v3.3.3 (Legacy)

Original chart with standalone PostgreSQL deployment:

- Manual PostgreSQL StatefulSet
- Manual Service and PVC templates
- Individual `env` entries (482-line StatefulSet)
- SOPS-focused secrets management
- No values schema validation

### v1.0.0 (Current)

Modernized chart following Helm v4 and Bitnami patterns:

- Bitnami PostgreSQL subchart dependency
- Three-approach secrets management
- ConfigMap with `envFrom` pattern (168-line StatefulSet)
- JSON Schema validation (95+ variables)
- Database abstraction helpers

::tip
**Reduction**: StatefulSet reduced from **482 lines to 168 lines** (65% reduction, -314 lines).
::

## Architecture Diagrams

### Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │               Heimdall Namespace                       │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │                                                         │  │
│  │  ┌─────────────────┐      ┌──────────────────┐        │  │
│  │  │   Ingress       │      │  Service         │        │  │
│  │  │  (Optional)     │─────▶│  ClusterIP:3000  │        │  │
│  │  └─────────────────┘      └────────┬─────────┘        │  │
│  │                                     │                   │  │
│  │                            ┌────────▼─────────┐        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  ┌────────────┐  │        │  │
│  │                            │  │ Heimdall   │  │        │  │
│  │                            │  │ Pod 1      │  │        │  │
│  │                            │  └────────────┘  │        │  │
│  │                            │       │          │        │  │
│  │                            └───────┼──────────┘        │  │
│  │                                    │                   │  │
│  │  ┌──────────────────┐      ┌──────▼──────────┐        │  │
│  │  │  ConfigMap       │      │  Secret          │        │  │
│  │  │  (env vars)      │      │  (credentials)   │        │  │
│  │  └──────────────────┘      └─────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PostgreSQL      │        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  (Bitnami)       │        │  │
│  │                            └──────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PVC             │        │  │
│  │                            │  (Database)      │        │  │
│  │                            └──────────────────┘        │  │
│  │                                                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### Secrets Management Flow

```
┌──────────────────────────────────────────────────────────┐
│              Secrets Management Priority                  │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  1. existingSecret (Production)                           │
│     ┌──────────────────────────────────┐                 │
│     │  External Secrets Operator       │                 │
│     │  Sealed Secrets                  │                 │
│     │  Vault                           │                 │
│     │  AWS Secrets Manager             │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Pre-existing)                    │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  2. secretsFiles (Development)                            │
│     ┌──────────────────────────────────┐                 │
│     │  env/heimdall-secrets.yaml       │                 │
│     │  (Gitignored, 0600 permissions)  │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Helm Template Rendering           │                  │
│  │  {{ .Files.Get "path" }}           │                  │
│  └────────────┬─────────────────────┘                    │
│               │                                           │
│               ▼                                           │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  3. secrets (CI/CD)                                       │
│     ┌──────────────────────────────────┐                 │
│     │  values.yaml or --set flags      │                 │
│     │  (From env vars / vault CLI)     │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

## Template Structure

### File Organization

```
heimdall/templates/
├── _helpers.tpl                    # Template functions
├── NOTES.txt                       # Post-install instructions
├── configmap.yaml                  # Environment variables
├── heimdall-secrets.yaml           # Secrets (three approaches)
├── heimdall-statefulset.yaml       # Main application
├── heimdall-service.yaml           # ClusterIP service
├── heimdall-serviceaccount.yaml    # ServiceAccount for pods
├── ingress.yaml                    # Ingress (HTTP/HTTPS routing)
├── gateway.yaml                    # Gateway API (alternative to Ingress)
├── networkpolicy.yaml              # NetworkPolicy (traffic restriction)
├── heimdall-cacerts-configmap.yaml # Custom CA certificates
├── hpa.yaml                        # HorizontalPodAutoscaler
├── poddisruptionbudget.yaml        # PodDisruptionBudget
├── db-migrate-job.yaml             # Sequelize migrations (TODO - Phase 2)
├── admin-user-job.yaml             # Admin creation (TODO - Phase 5)
├── tests/                          # Helm test templates
└── (PostgreSQL via Bitnami subchart - no local templates)
```

### Template Dependencies

```
_helpers.tpl
    ├── heimdall.fullname
    ├── heimdall.labels
    ├── heimdall.selectorLabels
    └── Database helpers
        ├── heimdall.databaseHost
        ├── heimdall.databasePort
        ├── heimdall.databaseName
        └── heimdall.databaseUsername

configmap.yaml
    ├── Uses: heimdall.databaseHost
    ├── Uses: heimdall.databasePort
    ├── Uses: heimdall.databaseName
    ├── Uses: heimdall.databaseUsername
    ├── Loads: env/heimdallconfig.yaml
    └── Merges: .Values.heimdall.config

heimdall-secrets.yaml
    ├── Priority 1: .Values.heimdall.existingSecret
    ├── Priority 2: .Values.heimdall.secrets
    └── Priority 3: .Values.heimdall.secretsFiles

heimdall-statefulset.yaml
    ├── Uses: heimdall.fullname
    ├── Uses: heimdall.labels
    ├── Uses: heimdall.selectorLabels
    ├── envFrom: ConfigMap
    └── envFrom: Secret
```

## envFrom Pattern

### Before (Individual env entries)

```yaml [Old approach - 337 lines]
env:
  - name: NODE_ENV
    value: {{ .Values.nodeEnv | quote }}
  - name: DATABASE_HOST
    value: {{ include "heimdall.databaseHost" . | quote }}
  - name: DATABASE_PORT
    value: {{ include "heimdall.databasePort" . | quote }}
  # ... 334 more individual env entries ...
```

### After (envFrom pattern)

```yaml [New approach - 23 lines]
envFrom:
  - configMapRef:
      name: {{ include "heimdall.fullname" . }}-config
  - secretRef:
      name: {{ ternary .Values.heimdall.existingSecret ... }}
env:
  # Only special cases
  {{- if .Values.certs.enabled }}
  - name: NODE_EXTRA_CA_CERTS
    value: /home/node/certs/certs.pem
  {{- end }}
```

::tip
**Benefits**: Cleaner templates, easier maintenance, follows Kubernetes patterns.
::

## Design Decisions

### Why Bitnami PostgreSQL Subchart?

::field-group
  ::field{name="Battle-tested"}
  Millions of deployments in production
  ::
  ::field{name="Feature-rich"}
  Built-in HA, backup/restore, metrics, monitoring
  ::
  ::field{name="Well-maintained"}
  Regular security updates and bug fixes
  ::
  ::field{name="Consistent"}
  Follows same patterns as other MITRE SAF charts (Vulcan)
  ::
::

### Why Three Secrets Approaches?

Different deployment scenarios require different workflows:

- **existingSecret**: Production with GitOps, external secret managers
- **secretsFiles**: Development with local testing, quick iteration
- **secrets**: CI/CD with environment injection, automated deployments

### Why envFrom Instead of Individual env?

::card-group
  ::card{icon="i-lucide-check" title="Pros"}
  - 65% code reduction
  - Easier to maintain
  - Follows Kubernetes patterns
  - Cleaner templates
  ::
  ::card{icon="i-lucide-info" title="Trade-offs"}
  - All ConfigMap keys become env vars
  - Harder to override individual vars
  - Need to namespace keys properly
  ::
::

### Why Template Helpers for Database?

Abstraction enables easy switching between deployment modes:

```yaml
# Development - Embedded database
postgresql:
  enabled: true

# Production - AWS RDS
postgresql:
  enabled: false
externalDatabase:
  host: db.example.com
```

Templates automatically adjust without modification.

## Helm v4 Compatibility

The chart is compatible with both Helm v3 and v4:

::field-group
  ::field{name="Server-Side Apply (SSA)"}
  Default in Helm v4, automatic benefits
  ::
  ::field{name="Content-based caching"}
  Faster chart operations
  ::
  ::field{name="Backwards compatibility"}
  Works with Helm 3.x (tested with 3.12+)
  ::
  ::field{name="No breaking changes"}
  Templates don't require modification
  ::
::

## Chart Features

The Heimdall Helm chart provides production-ready deployment capabilities:

### Database Management

- **Embedded PostgreSQL** - Bitnami subchart with HA, backup, metrics
- **External database** - Connect to AWS RDS, GCP Cloud SQL, Azure Database, etc.
- **Database abstraction** - Template helpers for seamless switching
- **Init containers** - PostgreSQL readiness checking before startup
- **Persistent storage** - Configurable PVCs via Bitnami subchart

### Secrets Management

- **Existing Secret** - ESO, Vault, Sealed Secrets, cloud secret managers
- **File-based** - Local development with gitignored files (auto-generated)
- **Inline** - CI/CD with environment variable injection
- **Priority system** - Automatic selection based on configuration

### High Availability

- **Health probes** - Startup, liveness, readiness with configurable thresholds
- **PodDisruptionBudget** - Maintain availability during cluster operations
- **HorizontalPodAutoscaler** - CPU/memory-based autoscaling (2-10 replicas)
- **Rolling updates** - StatefulSet RollingUpdate with configurable partitions
- **Resource management** - Requests/limits with sensible defaults

### Network & Security

- **Ingress** - Traefik, Nginx, AWS ALB, GCP LB, Azure App Gateway, Kong
- **Gateway API** - Alternative to Ingress (Kubernetes Gateway v1)
- **NetworkPolicy** - DNS, PostgreSQL, egress control
- **TLS/SSL** - cert-manager automation, manual certificates, wildcard support
- **Security contexts** - Non-root user, read-only filesystem, capability dropping
- **ServiceAccount** - Cloud IAM annotations (EKS IRSA, GKE Workload Identity)
- **Custom CA certificates** - Trust internal CAs for LDAP/OIDC

### Operations

- **Environment configuration** - 95+ variables with JSON Schema validation
- **ConfigMap with envFrom** - Clean environment variable management
- **Comprehensive documentation** - Nuxt UI site with examples and troubleshooting
- **Helm testing** - Built-in test templates for deployment verification
- **Validation** - Values schema, chart linting, unit tests (92 tests)

## Key Metrics

::field-group
  ::field{name="Code Reduction"}
  -314 lines in StatefulSet (65% reduction)
  ::
  ::field{name="Environment Variables"}
  95+ validated via JSON Schema Draft-07
  ::
  ::field{name="Secrets Approaches"}
  3 distinct methods for different scenarios
  ::
  ::field{name="Template Helpers"}
  4 database abstraction functions
  ::
  ::field{name="Helm Version"}
  Compatible with v3.x and v4.x
  ::
::

## Next Steps

::card-group
  ::card{icon="i-lucide-database" title="Database Setup" to="/helm-chart/getting-started/database"}
  Embedded and external PostgreSQL
  ::
  ::card{icon="i-lucide-key" title="Secrets Management" to="/helm-chart/getting-started/secrets"}
  Production-ready approaches
  ::
::
