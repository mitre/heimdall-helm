---
title: Database Configuration
description: PostgreSQL setup, migrations, and persistence for Heimdall
navigation:
  icon: i-lucide-database
---

The Heimdall Helm chart supports **two database deployment modes**: embedded PostgreSQL via Bitnami subchart, or external managed database.

## Database Deployment Modes

### Mode 1: Embedded PostgreSQL (Default)

Uses **Bitnami PostgreSQL subchart** for automatic database setup:

::card-group
  ::card{icon="i-lucide-check" title="Pros"}
  - Works out-of-box, no prerequisites
  - Automatic initialization
  - Consistent across environments
  - Good for development/testing
  ::
  ::card{icon="i-lucide-x" title="Cons"}
  - Requires persistent storage
  - Manual backup/restore
  - Single point of failure (without HA)
  ::
::

### Mode 2: External Database (Production)

Connect to managed database service:

::card-group
  ::card{icon="i-lucide-check" title="Pros"}
  - Managed backups
  - High availability built-in
  - Better performance
  - Separation of concerns
  ::
  ::card{icon="i-lucide-x" title="Cons"}
  - Requires pre-existing database
  - Additional cost
  - External dependency
  ::
::

## Embedded PostgreSQL Configuration

### Basic Setup

Default configuration (no changes needed):

```yaml [values.yaml]
postgresql:
  enabled: true

databaseName: heimdall
databaseUsername: postgres
```

### Persistence

Enable persistent storage:

```yaml [values.yaml]
postgresql:
  enabled: true

  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: ""  # Leave empty for default storage class
```

::tip
For production, specify a `storageClass` that provides **persistent volumes** (not `emptyDir`). Leave empty for cluster default.
::

### Resource Limits

Configure PostgreSQL resources:

```yaml [values.yaml]
postgresql:
  enabled: true

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
```

### PostgreSQL Version

Specify PostgreSQL version:

```yaml [values.yaml]
postgresql:
  enabled: true

  image:
    repository: postgres
    pullPolicy: Always
    tag: "17"
```

## External Database Configuration

### AWS RDS Example

```yaml [values.yaml]
postgresql:
  enabled: false

externalDatabase:
  host: heimdall-db.abc123.us-east-1.rds.amazonaws.com
  port: 5432
  database: heimdall_production
  username: heimdall_app
  existingSecret: heimdall-db-credentials
  existingSecretPasswordKey: password
```

Create the database credentials secret:

```bash [Terminal]
kubectl create secret generic heimdall-db-credentials \
  --namespace heimdall \
  --from-literal=password="your-secure-password"
```

### Google Cloud SQL Example

```yaml [values.yaml]
postgresql:
  enabled: false

externalDatabase:
  host: 10.1.2.3  # Private IP
  port: 5432
  database: heimdall
  username: heimdall-app
  existingSecret: heimdall-db-credentials
```

### Azure Database Example

```yaml [values.yaml]
postgresql:
  enabled: false

externalDatabase:
  host: heimdall-db.postgres.database.azure.com
  port: 5432
  database: heimdall
  username: heimdall_app@heimdall-db
  existingSecret: heimdall-db-credentials
```

## Database Migrations

### Sequelize Migrations

Heimdall uses **Sequelize** (NOT Rails ActiveRecord) for database migrations.

::note
This is different from Vulcan, which uses Rails `db:migrate`.
::

### Migration Job

The chart runs migrations via **Helm hook** before application deployment:

```yaml [templates/db-migrate-job.yaml]
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    spec:
      containers:
        - name: db-migrate
          image: mitre/heimdall2:release-latest
          command:
            - npx
            - sequelize-cli
            - db:migrate
```

### Migration Lifecycle

::steps{level="3"}

### PostgreSQL StatefulSet created

Bitnami subchart creates PostgreSQL with persistent storage.

### Init container waits for database

`check-db-ready` init container uses `pg_isready` to verify PostgreSQL is accepting connections.

### Migration job runs

Helm hook executes `sequelize-cli db:migrate` to update schema.

### Heimdall StatefulSet starts

Application pods start after migrations complete.

### Startup probe validates

Startup probe checks `/health_check` endpoint (includes database + migration validation).

### Readiness probe succeeds

Readiness probe checks `/health_check/database` endpoint (database connectivity only).

### Traffic routed to pods

Service endpoints updated to include ready pods.

::

## Init Container: Database Readiness

Both Heimdall StatefulSet and migration job wait for PostgreSQL:

```yaml [templates/heimdall-statefulset.yaml]
initContainers:
  - name: check-db-ready
    image: postgres:13-alpine
    command:
      - sh
      - -c
      - |
        until pg_isready \
          -h {{ include "heimdall.databaseHost" . }} \
          -p {{ include "heimdall.databasePort" . }} \
          -U {{ include "heimdall.databaseUsername" . }}
        do
          echo "Waiting for database..."
          sleep 2
        done
```

::tip
This prevents **connection refused** errors during startup.
::

## Current Migration Status

### Completed (Phase 1)

- âœ… Database abstraction helpers in `_helpers.tpl`
- âœ… ConfigMap with database connection details
- âœ… Secrets management (three approaches)
- âœ… External database support in values.yaml

### Implemented Features

- âœ… Bitnami PostgreSQL subchart integration
- âœ… Database init container for readiness checking
- âœ… Persistent volume support via Bitnami subchart
- âœ… Health probe configurations
- âœ… Database password management (three approaches)

### Planned Enhancements

- ðŸ“‹ Database migration Helm hooks (see [Database Migrations](./database-migrations))
- ðŸ“‹ Backup/restore runbooks
- ðŸ“‹ Automated backup scheduling with CronJobs
- ðŸ“‹ Admin user creation job

## Database Connection Details

### Connection String Format

Heimdall expects this connection format:

```
postgres://username:password@hostname:port/database
```

**Embedded PostgreSQL**:
```
postgres://postgres:PASSWORD@heimdall-postgresql:5432/heimdall
```

**External database**:
```
postgres://heimdall_app:PASSWORD@db.example.com:5432/heimdall_production
```

### Environment Variables

The chart automatically constructs database connection from:

::field-group
  ::field{name="DATABASE_HOST" type="string"}
  From helper: `heimdall.databaseHost`
  ::
  ::field{name="DATABASE_PORT" type="string"}
  From helper: `heimdall.databasePort`
  ::
  ::field{name="DATABASE_NAME" type="string"}
  From helper: `heimdall.databaseName`
  ::
  ::field{name="DATABASE_USERNAME" type="string"}
  From helper: `heimdall.databaseUsername`
  ::
  ::field{name="DATABASE_PASSWORD" type="string"}
  From Secret (loaded via `envFrom`)
  ::
::

## Troubleshooting

### Check PostgreSQL Status

```bash [Terminal]
# Check PostgreSQL pods
kubectl get pods -n heimdall | grep postgresql

# Check PostgreSQL logs
kubectl logs -n heimdall statefulset/heimdall-postgresql

# Check database connectivity
kubectl exec -n heimdall -it heimdall-postgresql-0 -- \
  psql -U postgres -d heimdall
```

### Check Migration Status

```bash [Terminal]
# Check migration job
kubectl get jobs -n heimdall

# View migration logs
kubectl logs -n heimdall job/heimdall-db-migrate

# Check Sequelize migration table
kubectl exec -n heimdall -it heimdall-postgresql-0 -- \
  psql -U postgres -d heimdall -c "SELECT * FROM \"SequelizeMeta\";"
```

### Common Issues

#### Issue: Init container stuck waiting for database

```bash [Terminal]
# Check init container logs
kubectl logs -n heimdall <pod-name> -c check-db-ready

# Check PostgreSQL is running
kubectl get pods -n heimdall | grep postgresql
```

#### Issue: Migration job failed

```bash [Terminal]
# View migration job logs
kubectl logs -n heimdall job/heimdall-db-migrate

# Manually run migrations
kubectl exec -n heimdall deployment/heimdall -- \
  npx sequelize-cli db:migrate
```

## Next Steps

::card-group
  ::card{icon="i-lucide-key" title="Secrets Management" to="/helm-chart/secrets"}
  Configure database credentials
  ::
  ::card{icon="i-lucide-code" title="Template Helpers" to="/helm-chart/helpers"}
  Database abstraction helpers
  ::
::
