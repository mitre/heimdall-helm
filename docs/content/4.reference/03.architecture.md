---
title: Chart Architecture
description: Technical architecture and implementation details
navigation:
  icon: i-lucide-layers
---

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │               Heimdall Namespace                       │  │
│  ├───────────────────────────────────────────────────────┤  │
│  │                                                         │  │
│  │  ┌─────────────────┐      ┌──────────────────┐        │  │
│  │  │   Ingress       │      │  Service         │        │  │
│  │  │  (Optional)     │─────▶│  ClusterIP:3000  │        │  │
│  │  └─────────────────┘      └────────┬─────────┘        │  │
│  │                                     │                   │  │
│  │                            ┌────────▼─────────┐        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  ┌────────────┐  │        │  │
│  │                            │  │ Heimdall   │  │        │  │
│  │                            │  │ Pod 1      │  │        │  │
│  │                            │  └────────────┘  │        │  │
│  │                            │       │          │        │  │
│  │                            └───────┼──────────┘        │  │
│  │                                    │                   │  │
│  │  ┌──────────────────┐      ┌──────▼──────────┐        │  │
│  │  │  ConfigMap       │      │  Secret          │        │  │
│  │  │  (env vars)      │      │  (credentials)   │        │  │
│  │  └──────────────────┘      └─────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PostgreSQL      │        │  │
│  │                            │  StatefulSet     │        │  │
│  │                            │  (Bitnami)       │        │  │
│  │                            └──────────────────┘        │  │
│  │                                    │                   │  │
│  │                            ┌───────▼──────────┐        │  │
│  │                            │  PVC             │        │  │
│  │                            │  (Database)      │        │  │
│  │                            └──────────────────┘        │  │
│  │                                                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Secrets Management Flow

```
┌──────────────────────────────────────────────────────────┐
│              Secrets Management Priority                  │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  1. existingSecret (Production)                           │
│     ┌──────────────────────────────────┐                 │
│     │  External Secrets Operator       │                 │
│     │  Sealed Secrets                  │                 │
│     │  Vault                           │                 │
│     │  AWS Secrets Manager             │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Pre-existing)                    │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  2. secretsFiles (Development)                            │
│     ┌──────────────────────────────────┐                 │
│     │  env/heimdall-secrets.yaml       │                 │
│     │  (Gitignored, 0600 permissions)  │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Helm Template Rendering           │                  │
│  │  {{ .Files.Get "path" }}           │                  │
│  └────────────┬─────────────────────┘                    │
│               │                                           │
│               ▼                                           │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
│  3. secrets (CI/CD)                                       │
│     ┌──────────────────────────────────┐                 │
│     │  values.yaml or --set flags      │                 │
│     │  (From env vars / vault CLI)     │                 │
│     └────────────┬─────────────────────┘                 │
│                  │                                        │
│                  ▼                                        │
│  ┌────────────────────────────────────┐                  │
│  │  Kubernetes Secret                 │                  │
│  │  (Created by chart)                │                  │
│  └────────────────────────────────────┘                  │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

## Template Structure

### File Organization

```
heimdall/templates/
├── _helpers.tpl                    # Template functions
├── NOTES.txt                       # Post-install instructions
├── configmap.yaml                  # Environment variables
├── heimdall-secrets.yaml           # Secrets (three approaches)
├── heimdall-statefulset.yaml       # Main application
├── heimdall-service.yaml           # ClusterIP service
├── heimdall-serviceaccount.yaml    # ServiceAccount for pods
├── ingress.yaml                    # Ingress (HTTP/HTTPS routing)
├── gateway.yaml                    # Gateway API (alternative to Ingress)
├── networkpolicy.yaml              # NetworkPolicy (traffic restriction)
├── heimdall-cacerts-configmap.yaml # Custom CA certificates
├── hpa.yaml                        # HorizontalPodAutoscaler
├── poddisruptionbudget.yaml        # PodDisruptionBudget
├── db-migrate-job.yaml             # Sequelize migrations (TODO - Phase 2)
├── admin-user-job.yaml             # Admin creation (TODO - Phase 5)
├── tests/                          # Helm test templates
└── (PostgreSQL via Bitnami subchart - no local templates)
```

### Template Dependencies

```
_helpers.tpl
    ├── heimdall.fullname
    ├── heimdall.labels
    ├── heimdall.selectorLabels
    └── Database helpers
        ├── heimdall.databaseHost
        ├── heimdall.databasePort
        ├── heimdall.databaseName
        └── heimdall.databaseUsername

configmap.yaml
    ├── Uses: heimdall.databaseHost
    ├── Uses: heimdall.databasePort
    ├── Uses: heimdall.databaseName
    ├── Uses: heimdall.databaseUsername
    ├── Loads: env/heimdallconfig.yaml
    └── Merges: .Values.heimdall.config

heimdall-secrets.yaml
    ├── Priority 1: .Values.heimdall.existingSecret
    ├── Priority 2: .Values.heimdall.secrets
    └── Priority 3: .Values.heimdall.secretsFiles

heimdall-statefulset.yaml
    ├── Uses: heimdall.fullname
    ├── Uses: heimdall.labels
    ├── Uses: heimdall.selectorLabels
    ├── envFrom: ConfigMap
    └── envFrom: Secret
```

### envFrom Pattern

Reduces StatefulSet from 482 lines to 168 lines.

**Before:**
```yaml
env:
  - name: NODE_ENV
    value: {{ .Values.nodeEnv | quote }}
  - name: DATABASE_HOST
    value: {{ include "heimdall.databaseHost" . | quote }}
  # ... 334 more entries ...
```

**After:**
```yaml
envFrom:
  - configMapRef:
      name: {{ include "heimdall.fullname" . }}-config
  - secretRef:
      name: {{ ternary .Values.heimdall.existingSecret ... }}
env:
  # Only special cases
  {{- if .Values.certs.enabled }}
  - name: NODE_EXTRA_CA_CERTS
    value: /home/node/certs/certs.pem
  {{- end }}
```

**Trade-offs:**
- All ConfigMap keys become env vars
- Harder to override individual vars
- Requires proper key namespacing

### Database Helpers

Template helpers abstract database connection:

```yaml
# Embedded PostgreSQL
postgresql:
  enabled: true

# External database
postgresql:
  enabled: false
externalDatabase:
  host: db.example.com
```

Templates use `heimdall.databaseHost`, `heimdall.databasePort`, `heimdall.databaseName`, `heimdall.databaseUsername` helpers that automatically return the correct values based on configuration.

## Chart Components

### Database

- Bitnami PostgreSQL subchart (embedded mode)
- External database support (AWS RDS, GCP Cloud SQL, Azure Database)
- Init containers for readiness checking
- Persistent volume support

### Secrets

- `existingSecret` - Reference external secret (production)
- `secretsFiles` - Load from files (development)
- `secrets` - Inline values (CI/CD)

### High Availability

- Startup/liveness/readiness probes
- PodDisruptionBudget
- HorizontalPodAutoscaler (CPU/memory-based)
- Rolling update strategy
- Resource requests/limits

### Network & Security

- Ingress support (Traefik, Nginx, cloud load balancers)
- Gateway API support
- NetworkPolicy templates
- TLS/SSL with cert-manager or manual certificates
- Security contexts (non-root, read-only filesystem)
- ServiceAccount with cloud IAM annotations
- Custom CA certificate support

### Configuration

- JSON Schema validation (95+ variables)
- ConfigMap for environment variables
- Template helpers for database abstraction
- Helm test templates

## Helm Compatibility

Compatible with Helm v3.12+ and v4.x. Templates work with both versions without modification.
