---
title: Availability Troubleshooting
description: Common health probe, PDB, and HPA issues
navigation:
  icon: i-lucide-wrench
---

Common availability problems and solutions.

## Pod Stuck in Init

**Symptom**: Pod shows `Init:0/1` status

**Cause**: wait-for-db init container can't reach PostgreSQL

### Debug

```bash
kubectl logs -n heimdall heimdall-0 -c wait-for-db
```

### Common Issues

- PostgreSQL not ready yet (wait longer)
- Wrong database host/port in values.yaml
- Network policy blocking connection
- PostgreSQL service doesn't exist

### Fix

Check PostgreSQL pod:
```bash
kubectl get pods -n heimdall | grep postgresql
```

Check service:
```bash
kubectl get svc -n heimdall | grep postgresql
```

Verify connectivity:
```bash
kubectl run -it --rm debug --image=postgres:16-alpine --restart=Never -- \
  pg_isready -h heimdall-postgresql -p 5432
```

---

## Startup Probe Failing

**Symptom**: Pod restarts repeatedly with `CrashLoopBackOff`

**Cause**: Startup takes longer than failureThreshold allows

### Check Startup Time

```bash
kubectl logs -n heimdall heimdall-0 | grep "Heimdall is now running"
```

### Fix

Increase failureThreshold:

```yaml
heimdall:
  startupProbe:
    failureThreshold: 60  # 10 minutes (60 Ã— 10s)
```

---

## Liveness Probe Killing Healthy Pods

**Symptom**: Pods restart unexpectedly

**Cause**: Application temporarily slow (migrations, database queries)

### Check Restart Count

```bash
kubectl get pods -n heimdall
```

Look for high RESTARTS count.

### Fix

Increase timeoutSeconds or failureThreshold:

```yaml
heimdall:
  livenessProbe:
    timeoutSeconds: 10  # Longer timeout
    failureThreshold: 5  # More tolerant
```

---

## HPA Not Scaling

**Symptom**: CPU > target but no scaling occurs

### Check metrics-server

```bash
kubectl top pods -n heimdall
```

If error: metrics-server not installed

Install metrics-server:
```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

### Check Resource Requests

```bash
kubectl describe pod -n heimdall heimdall-0 | grep -A 5 "Requests:"
```

HPA requires resource requests to calculate utilization percentage.

### Fix

Add resource requests:

```yaml
heimdall:
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
```

---

## PDB Blocking Node Drain

**Symptom**: `kubectl drain` hangs with "Cannot evict pod"

**Cause**: Not enough healthy replicas to satisfy PDB

### Check PDB Status

```bash
kubectl get pdb -n heimdall
# ALLOWED DISRUPTIONS: 0 means PDB is blocking
```

### Fix

Scale up temporarily:

```bash
# Increase replicas to allow disruption
helm upgrade heimdall ./heimdall -n heimdall \
  --set heimdall.replicaCount=3

# Wait for new pod to be ready
kubectl get pods -n heimdall -w

# Now drain will succeed (PDB allows 1 disruption)
kubectl drain <node-name> --ignore-daemonsets
```

---

## Readiness Probe Failing

**Symptom**: Pod running but not receiving traffic

### Check Service Endpoints

```bash
kubectl get endpoints -n heimdall
```

If no endpoints listed, pods aren't ready.

### Check Readiness Probe

```bash
kubectl describe pod -n heimdall heimdall-0
```

Look for `Readiness probe failed` in events.

### Test Manually

```bash
kubectl port-forward -n heimdall heimdall-0 8080:3000
curl http://localhost:8080/
```

If manual test works, adjust probe settings:

```yaml
heimdall:
  readinessProbe:
    periodSeconds: 15  # Less frequent
    timeoutSeconds: 10  # Longer timeout
    failureThreshold: 5  # More tolerant
```

---

## HPA Oscillating (Flapping)

**Symptom**: HPA constantly scales up and down

**Cause**: Target utilization too close to actual load

### Check HPA Behavior

```bash
kubectl get hpa -n heimdall -w
```

Watch for rapid scaling changes.

### Fix

Adjust target percentage or add stabilization window:

```yaml
heimdall:
  autoscaling:
    targetCPUUtilizationPercentage: 60  # Lower target (scale earlier)
```

Or add buffer to resource requests:

```yaml
heimdall:
  resources:
    requests:
      cpu: 400m  # Lower request = higher utilization at same usage
```

---

## Slow Rolling Updates

**Symptom**: Updates take too long

**Cause**: Conservative health probe settings

### Speed Up Readiness Checks

```yaml
heimdall:
  readinessProbe:
    periodSeconds: 5  # Faster checks
    failureThreshold: 2  # Fail faster
```

### Check Update Progress

```bash
kubectl rollout status statefulset/heimdall -n heimdall
```

---

## Pod Eviction During Updates

**Symptom**: Pods evicted during rolling update

**Cause**: PDB too restrictive for update strategy

### Check PDB vs Replicas

```bash
kubectl get pdb -n heimdall
kubectl get statefulset heimdall -n heimdall -o jsonpath='{.spec.replicas}'
```

### Fix

Adjust PDB to allow updates:

```yaml
heimdall:
  replicaCount: 3
  podDisruptionBudget:
    enabled: true
    minAvailable: 1  # Allows 2 disruptions (3 - 1)
```

---

## See Also

- [Health Probes](/helm-chart/advanced/availability/health-probes) - Configure probes
- [High Availability](/helm-chart/advanced/availability/high-availability) - PDB and HPA
- [Database Configuration](/helm-chart/getting-started/database) - PostgreSQL setup
